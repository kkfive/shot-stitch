name: ç”Ÿæˆè§†é¢‘æˆªå›¾

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'è§†é¢‘ URL'
        required: true
        type: string
      preset:
        description: 'é¢„è®¾æ¨¡å¼'
        required: false
        default: 'dynamic'
        type: choice
        options:
        - movie
        - lecture
        - quick
        - dynamic
      target_repo:
        description: 'å‘å¸ƒåˆ°çš„ä»“åº“'
        required: false
        default: 'kkfive/shot-stitch'
        type: string
      custom_filename:
        description: 'è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¯é€‰ï¼Œä¸å«æ‰©å±•åï¼Œç”¨äºé‡å‘½åä¸‹è½½çš„è§†é¢‘æ–‡ä»¶ï¼‰'
        required: false
        type: string


permissions:
  contents: read

jobs:
  generate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: éªŒè¯è¾“å…¥
      run: |
        if [[ ! "$VIDEO_URL" =~ ^https?:// ]]; then
          echo "âŒ æ— æ•ˆçš„ URL æ ¼å¼"
          exit 1
        fi
        echo "âœ… URL éªŒè¯é€šè¿‡"

        # éªŒè¯è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¦‚æœæä¾›ï¼‰
        if [ -n "$CUSTOM_FILENAME" ]; then
          # æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸å®‰å…¨çš„å­—ç¬¦
          if [[ "$CUSTOM_FILENAME" =~ [\<\>\:\"\|\?\*\/\\] ]]; then
            echo "âŒ è‡ªå®šä¹‰æ–‡ä»¶ååŒ…å«ä¸å®‰å…¨çš„å­—ç¬¦: $CUSTOM_FILENAME"
            echo "è¯·é¿å…ä½¿ç”¨ä»¥ä¸‹å­—ç¬¦: < > : \" | ? * / \\"
            exit 1
          fi
          # æ£€æŸ¥é•¿åº¦
          if [ ${#CUSTOM_FILENAME} -gt 100 ]; then
            echo "âŒ è‡ªå®šä¹‰æ–‡ä»¶åè¿‡é•¿ï¼ˆè¶…è¿‡100å­—ç¬¦ï¼‰: $CUSTOM_FILENAME"
            exit 1
          fi
          echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶åéªŒè¯é€šè¿‡: $CUSTOM_FILENAME"
        fi
      env:
        VIDEO_URL: ${{ inputs.video_url }}
        CUSTOM_FILENAME: ${{ inputs.custom_filename }}
    
    - name: è®¾ç½® Hosts æ˜ å°„
      run: |
        if [ -n "$HOSTS_MAPPING" ]; then
          echo "ğŸ”§ è®¾ç½® hosts æ˜ å°„..."
          echo "$HOSTS_MAPPING" | sudo tee -a /etc/hosts > /dev/null
          echo "âœ… Hosts æ˜ å°„è®¾ç½®å®Œæˆ"
        else
          echo "â„¹ï¸ æœªè®¾ç½® hosts æ˜ å°„ï¼Œè·³è¿‡"
        fi
      env:
        HOSTS_MAPPING: ${{ secrets.HOSTS_MAPPING }}
    
    - name: ä¸‹è½½è§†é¢‘
      run: |
        mkdir -p video_input

        echo "â¬‡ï¸ æ­£åœ¨è·å–è§†é¢‘èµ„æº..."
        echo "ğŸ”— URL: $VIDEO_URL"

        # ä» URL ä¸­æå–åŸå§‹æ–‡ä»¶å
        URL_FILENAME=$(echo "$VIDEO_URL" | sed 's/.*\///' | sed 's/\?.*$//')
        if [ -z "$URL_FILENAME" ] || [[ ! "$URL_FILENAME" =~ \. ]]; then
          URL_FILENAME="video.mp4"
        fi

        echo "ğŸ“ URLä¸­çš„æ–‡ä»¶å: $URL_FILENAME"

        # æå–æ‰©å±•åï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
        if [[ "$URL_FILENAME" =~ \. ]]; then
          EXTENSION="${URL_FILENAME##*.}"
        else
          EXTENSION="mp4"
        fi

        # ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„æ–‡ä»¶å
        if [ -n "${{ inputs.custom_filename }}" ]; then
          # 1. ç”¨æˆ·ä¼ å…¥é‡å‘½åå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¼ å…¥çš„åç§°
          FINAL_FILENAME="${{ inputs.custom_filename }}.${EXTENSION}"
          echo "ğŸ“ ä½¿ç”¨è‡ªå®šä¹‰æ–‡ä»¶å: $FINAL_FILENAME"
        else
          # 2. ç”¨æˆ·æœªä¼ å…¥é‡å‘½åå‚æ•°ï¼Œæ£€æµ‹æ˜¯å¦éœ€è¦è§£ç 
          if [[ "$URL_FILENAME" =~ %[0-9A-Fa-f]{2} ]]; then
            # æ£€æµ‹åˆ°URLç¼–ç ï¼Œè¿›è¡Œè§£ç 
            DECODED_FILENAME=$(printf '%b' "${URL_FILENAME//%/\\x}")
            FINAL_FILENAME="$DECODED_FILENAME"
            echo "ğŸ“ æ£€æµ‹åˆ°URLç¼–ç ï¼Œè§£ç å: $FINAL_FILENAME"
          else
            # æ— éœ€è§£ç 
            FINAL_FILENAME="$URL_FILENAME"
            echo "ğŸ“ ä½¿ç”¨åŸå§‹æ–‡ä»¶å: $FINAL_FILENAME"
          fi
        fi

        echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV
        echo "URL_FILENAME=$URL_FILENAME" >> $GITHUB_ENV

        # é¦–å…ˆè·å–æ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“Š è·å–æ–‡ä»¶ä¿¡æ¯..."
        CONTENT_LENGTH=$(curl -sI -L "$VIDEO_URL" | grep -i content-length | tail -1 | cut -d' ' -f2 | tr -d '\r')
        if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
          CONTENT_LENGTH_MB=$((CONTENT_LENGTH / 1024 / 1024))
          echo "ğŸ“ æ–‡ä»¶å¤§å°: ${CONTENT_LENGTH_MB}MB"
        else
          echo "âš ï¸ æ— æ³•è·å–æ–‡ä»¶å¤§å°ä¿¡æ¯"
        fi

        # ä½¿ç”¨ curl ä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶å
        TEMP_FILENAME="temp_download_$(date +%s).tmp"
        echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½..."
        if curl -L --fail --progress-bar \
               --connect-timeout 30 --max-time 3600 \
               --user-agent "Mozilla/5.0 (compatible; VideoProcessor/1.0)" \
               --output "video_input/$TEMP_FILENAME" \
               --write-out "âœ… ä¸‹è½½å®Œæˆ - å®é™…å¤§å°: %{size_download} å­—èŠ‚ - æ€»ç”¨æ—¶: %{time_total}s - å¹³å‡é€Ÿåº¦: %{speed_download} B/s\n" \
               "$VIDEO_URL"; then

          # éªŒè¯æ–‡ä»¶å¹¶æ˜¾ç¤ºå‹å¥½çš„å¤§å°
          if [ -f "video_input/$TEMP_FILENAME" ] && [ -s "video_input/$TEMP_FILENAME" ]; then
            FILE_SIZE=$(du -h "video_input/$TEMP_FILENAME" | cut -f1)
            FILE_SIZE_BYTES=$(stat -c%s "video_input/$TEMP_FILENAME" 2>/dev/null || stat -f%z "video_input/$TEMP_FILENAME" 2>/dev/null)
            echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶å¤§å°: ${FILE_SIZE} (${FILE_SIZE_BYTES} å­—èŠ‚)"

            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆå¦‚æœæœ‰é¢„æœŸå¤§å°ï¼‰
            if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
              if [ "$FILE_SIZE_BYTES" -eq "$CONTENT_LENGTH" ]; then
                echo "âœ… æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡"
              else
                echo "âš ï¸ æ–‡ä»¶å¤§å°ä¸åŒ¹é… (é¢„æœŸ: $CONTENT_LENGTH, å®é™…: $FILE_SIZE_BYTES)"
              fi
            fi

            # é‡å‘½åä¸´æ—¶æ–‡ä»¶åˆ°æœ€ç»ˆæ–‡ä»¶å
            echo "ğŸ”„ é‡å‘½åæ–‡ä»¶: $TEMP_FILENAME â†’ $FINAL_FILENAME"
            mv "video_input/$TEMP_FILENAME" "video_input/$FINAL_FILENAME"

            if [ -f "video_input/$FINAL_FILENAME" ]; then
              echo "âœ… æ–‡ä»¶é‡å‘½åæˆåŠŸ: $FINAL_FILENAME"
            else
              echo "âŒ æ–‡ä»¶é‡å‘½åå¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆæˆ–ä¸ºç©º"
            exit 1
          fi
        else
          echo "âŒ è§†é¢‘ä¸‹è½½å¤±è´¥"
          exit 1
        fi
      env:
        VIDEO_URL: ${{ inputs.video_url }}
    
    - name: ç”Ÿæˆæˆªå›¾
      run: |
        echo "ğŸ¬ å¼€å§‹ç”Ÿæˆæˆªå›¾..."

        # ä»æœ€ç»ˆæ–‡ä»¶åä¸­æå–åŸºç¡€åç§°ï¼ˆä¸å«æ‰©å±•åï¼‰
        VIDEO_FILENAME=$(echo "$FINAL_FILENAME" | sed 's/\.[^.]*$//')
        # æ³¨æ„ï¼šä¿æŒä¸­æ–‡å­—ç¬¦ï¼Œåªæ¸…ç†åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰é—®é¢˜çš„å­—ç¬¦
        VIDEO_FILENAME=$(echo "$VIDEO_FILENAME" | sed 's/[<>:"|?*\/\\]/_/g' | sed 's/__*/_/g' | sed 's/^_\|_$//g')

        # ä¸ºDockerå®¹å™¨åˆ›å»ºASCIIå®‰å…¨çš„å·¥ä½œæ–‡ä»¶åï¼ˆç”¨äºå†…éƒ¨å¤„ç†ï¼‰
        # ä½†ä¿æŒåŸå§‹æ–‡ä»¶åç”¨äºæœ€ç»ˆè¾“å‡º
        DOCKER_SAFE_FILENAME=$(echo "$FINAL_FILENAME" | sed 's/[^a-zA-Z0-9._-]/_/g' | sed 's/__*/_/g' | sed 's/^_\|_$//g')
        if [ "$DOCKER_SAFE_FILENAME" != "$FINAL_FILENAME" ]; then
          echo "ğŸ“ Dockerå®‰å…¨æ–‡ä»¶å: $DOCKER_SAFE_FILENAME"
          # åˆ›å»ºASCIIå®‰å…¨çš„ç¬¦å·é“¾æ¥
          ln -sf "$FINAL_FILENAME" "video_input/$DOCKER_SAFE_FILENAME"
        else
          DOCKER_SAFE_FILENAME="$FINAL_FILENAME"
        fi

        echo "ğŸ“ å¤„ç†æ–‡ä»¶: $FINAL_FILENAME"
        echo "ğŸ“ åŸºç¡€æ–‡ä»¶å: $VIDEO_FILENAME"
        echo "VIDEO_FILENAME=$VIDEO_FILENAME" >> $GITHUB_ENV

        # è¿è¡Œ shot-stitch Docker å®¹å™¨ï¼Œä½¿ç”¨ASCIIå®‰å…¨çš„æ–‡ä»¶å
        # è®¾ç½®UTF-8ç¯å¢ƒå˜é‡ä»¥æ”¯æŒä¸­æ–‡æ–‡ä»¶å
        docker run --rm \
          -e LANG=C.UTF-8 \
          -e LC_ALL=C.UTF-8 \
          -v $(pwd)/video_input:/data \
          dreamytzk/shot-stitch:latest \
          "/data/$DOCKER_SAFE_FILENAME" \
          --preset ${{ inputs.preset }} \
          --html \
          --force

        # å¦‚æœä½¿ç”¨äº†ASCIIå®‰å…¨æ–‡ä»¶åï¼Œéœ€è¦é‡å‘½åç”Ÿæˆçš„æ–‡ä»¶
        if [ "$DOCKER_SAFE_FILENAME" != "$FINAL_FILENAME" ]; then
          echo "ğŸ”„ é‡å‘½åç”Ÿæˆçš„æ–‡ä»¶å›ä¸­æ–‡æ–‡ä»¶å..."
          DOCKER_SAFE_BASE=$(echo "$DOCKER_SAFE_FILENAME" | sed 's/\.[^.]*$//')

          # é‡å‘½åæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          for file in video_input/${DOCKER_SAFE_BASE}*; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "$DOCKER_SAFE_FILENAME" ]; then
              new_name=$(echo "$(basename "$file")" | sed "s/^${DOCKER_SAFE_BASE}/${VIDEO_FILENAME}/")
              mv "$file" "video_input/$new_name"
              echo "  é‡å‘½å: $(basename "$file") â†’ $new_name"
            fi
          done

          # åˆ é™¤ASCIIå®‰å…¨çš„ç¬¦å·é“¾æ¥
          rm -f "video_input/$DOCKER_SAFE_FILENAME"
        fi

        # å®šä¹‰æŸ¥æ‰¾ç”Ÿæˆæ–‡ä»¶çš„å‡½æ•°ï¼ˆé¿å…evalï¼‰
        find_generated_files() {
          find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$FINAL_FILENAME"
        }

        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        SCREENSHOT_COUNT=$(find_generated_files | wc -l)

        if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•æˆªå›¾æ–‡ä»¶"
          exit 1
        fi

        echo "âœ… æˆªå›¾ç”Ÿæˆå®Œæˆï¼Œå…±ç”Ÿæˆ $SCREENSHOT_COUNT ä¸ªæ–‡ä»¶"

        # åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        echo "ğŸ“Š ç”Ÿæˆçš„æ–‡ä»¶:"
        find_generated_files | while read file; do
          echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
        done
    
    - name: å‡†å¤‡ Release ä¿¡æ¯
      run: |
        # å®šä¹‰æŸ¥æ‰¾ç”Ÿæˆæ–‡ä»¶çš„å‡½æ•°
        find_generated_files() {
          find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$FINAL_FILENAME"
        }

        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        RELEASE_TAG="screenshots-${TIMESTAMP}"
        RELEASE_NAME="$VIDEO_FILENAME æˆªå›¾ - $(date '+%Y-%m-%d %H:%M:%S')"
        TARGET_REPO="${{ inputs.target_repo }}"

        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
        echo "TARGET_REPO=$TARGET_REPO" >> $GITHUB_ENV

        # åˆ›å»º Release æè¿°
        echo "# è§†é¢‘æˆªå›¾æ–‡ä»¶" > release_notes.md
        echo "" >> release_notes.md
        echo "**è§†é¢‘æ–‡ä»¶å**: \`$VIDEO_FILENAME\`" >> release_notes.md
        # å¦‚æœä½¿ç”¨äº†è‡ªå®šä¹‰æ–‡ä»¶åæˆ–è¿›è¡Œäº†URLè§£ç ï¼Œæ˜¾ç¤ºåŸå§‹URLæ–‡ä»¶å
        if [ -n "${{ inputs.custom_filename }}" ] || [[ "$URL_FILENAME" =~ %[0-9A-Fa-f]{2} ]]; then
          echo "**åŸå§‹URLæ–‡ä»¶å**: \`$URL_FILENAME\`" >> release_notes.md
        fi
        echo "**é¢„è®¾æ¨¡å¼**: \`${{ inputs.preset }}\`" >> release_notes.md
        echo "**ç›®æ ‡ä»“åº“**: \`$TARGET_REPO\`" >> release_notes.md
        echo "**ç”Ÿæˆæ—¶é—´**: \`$(date '+%Y-%m-%d %H:%M:%S')\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## åŒ…å«æ–‡ä»¶" >> release_notes.md
        find_generated_files | while read file; do
          echo "- \`$(basename "$file")\` ($(du -h "$file" | cut -f1))" >> release_notes.md
        done
        echo "- \`${VIDEO_FILENAME}_all_files.zip\` (åŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…)" >> release_notes.md
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> release_notes.md

        echo "âœ… Release ä¿¡æ¯å‡†å¤‡å®Œæˆ"
    
    - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      run: |
        # å®šä¹‰æŸ¥æ‰¾ç”Ÿæˆæ–‡ä»¶çš„å‡½æ•°
        find_generated_files() {
          find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$FINAL_FILENAME"
        }

        echo "ğŸš€ åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶..."

        # åˆ›å»º Release
        gh release create "$RELEASE_TAG" \
          --repo "$TARGET_REPO" \
          --title "$RELEASE_NAME" \
          --notes-file release_notes.md

        echo "âœ… Release åˆ›å»ºæˆåŠŸ: $RELEASE_TAG"

        # ä¸Šä¼ æ‰€æœ‰æˆªå›¾æ–‡ä»¶
        echo "ğŸ“¤ ä¸Šä¼ æˆªå›¾æ–‡ä»¶..."
        find_generated_files | while read file; do
          filename=$(basename "$file")
          echo "ğŸ“¤ ä¸Šä¼ : $filename"

          gh release upload "$RELEASE_TAG" "$file" \
            --repo "$TARGET_REPO" \
            --clobber
        done

        # åˆ›å»ºåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…
        echo "ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…..."
        mkdir -p temp_upload

        # å¤åˆ¶æ‰€æœ‰æˆªå›¾æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        find_generated_files | while read file; do
          cp "$file" temp_upload/
        done

        cd temp_upload
        zip_filename="${VIDEO_FILENAME}_all_files.zip"
        zip -r "$zip_filename" .
        echo "ğŸ“¤ ä¸Šä¼ å‹ç¼©åŒ…: $zip_filename"

        gh release upload "$RELEASE_TAG" "$zip_filename" \
          --repo "$TARGET_REPO" \
          --clobber
        cd ..

        echo "âœ… æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
        echo "RELEASE_URL=https://github.com/$TARGET_REPO/releases/tag/$RELEASE_TAG" >> $GITHUB_ENV
      env:
        GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
    
    - name: ç”Ÿæˆä¸‹è½½ä¿¡æ¯
      run: |
        # å®šä¹‰æŸ¥æ‰¾ç”Ÿæˆæ–‡ä»¶çš„å‡½æ•°
        find_generated_files() {
          find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$FINAL_FILENAME"
        }

        echo "ğŸ‰ æˆªå›¾å·²æˆåŠŸä¸Šä¼ åˆ°ç›®æ ‡ä»“åº“!"
        echo ""
        echo "ğŸ“ ç›®æ ‡ä»“åº“: $TARGET_REPO"
        echo "ğŸ·ï¸  Release æ ‡ç­¾: $RELEASE_TAG"
        echo "ğŸ”— Release é“¾æ¥: $RELEASE_URL"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
        echo "1. è®¿é—®ç›®æ ‡ä»“åº“çš„ Releases é¡µé¢"
        echo "2. æ‰¾åˆ°æ ‡ç­¾ä¸º '$RELEASE_TAG' çš„ Release"
        echo "3. ç›´æ¥ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼ˆæ— éœ€è§£å‹ï¼‰"
        echo ""
        echo "ğŸ“Š å¯ä¸‹è½½çš„æ–‡ä»¶:"
        find_generated_files | while read file; do
          echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
        done
        echo "  - ${VIDEO_FILENAME}_all_files.zip (åŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…)"
        echo ""
        echo "ğŸ”’ åªæœ‰ç›®æ ‡ä»“åº“çš„åä½œè€…å¯ä»¥è®¿é—®å’Œä¸‹è½½"
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf video_input/ release_notes.md temp_upload/
        echo "âœ… æ¸…ç†å®Œæˆ"
