# 更新日志

本项目的所有重要更改都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)，
本项目遵循 [语义化版本](https://semver.org/spec/v2.0.0.html)。

## [0.5.0] - 2025-07-27

### 🚀 新增功能

#### 保留小图片功能
- **新增**: `--keep-frames` 参数，支持保留截图的小图片到与文件同名的文件夹中
- **智能管理**: 自动清理已存在的小图片文件夹，避免混合不同处理结果
- **用户友好**: 清晰显示保留的图片数量和存储位置
- **灵活配置**: 可通过配置文件设置默认行为

### 🔧 场景检测算法重构

#### 算法优化和简化
- **重构**: 场景检测算法核心逻辑，移除过度优化的"超级优化"模式
- **统一**: 分段处理逻辑，支持auto和数字两种分段配置模式
- **改进**: 超时处理机制，扩展超时时间但确保任务完成
- **修复**: 阈值处理，严格遵守用户配置不私自修改
- **优化**: 进度显示，使用两位数分段编号(01,02...)提升可读性

#### 配置系统增强
- **新增**: `SCENE_DETECTION_SEGMENTS_MULTIPLIER` 参数控制自动分段倍数
- **完善**: 配置验证，支持auto值和正整数验证
- **改进**: 配置导出机制，确保环境变量正确传递
- **优化**: 输出文件名生成，修复场景阈值格式化问题

#### 代码质量提升
- **新增**: `calculate_segment_count()` 辅助函数统一分段计算
- **重命名**: `detect_scene_changes_ultra_optimized` 为 `detect_scene_changes_standard`
- **统一**: CPU核心检测逻辑，使用 `detect_cpu_cores()` 函数
- **改进**: 错误处理和进度监控机制

### 🎯 预设配置优化

#### Dynamic预设增强
- **优化**: 场景检测参数配置，提升动态内容处理效果
- **增加**: 分批大小从30帧提升到48帧，减少处理次数提高效率
- **新增**: 详细的配置说明和示例
- **设置**: 合理的默认值确保最佳性能

### 🤖 GitHub Actions改进
- **增强**: 中文文件名处理能力，支持URL编码解码
- **优化**: 文件名检测和处理逻辑
- **改进**: 错误处理和用户体验

### 🐛 修复和改进
- **修复**: 配置验证和文件名生成逻辑
- **改进**: 场景检测算法的稳定性和准确性
- **优化**: 临时文件管理和清理机制
- **增强**: 用户反馈和进度显示

### 📊 兼容性
- **保持**: 向后兼容，现有配置文件无需修改
- **默认值**: 新增的配置参数有合理默认值
- **输出格式**: 算法改进不影响输出格式

## [0.4.2] - 2025-07-27

### 🔧 回归修复
- **修复**: FFmpeg输出重定向错误，解决showinfo数据写入错误文件问题
- **修复**: 分段完成检测逻辑，正确识别包含场景检测数据的成功分段
- **修复**: 虚假成功报告问题，确保图片生成失败时正确报告错误状态

### 🐛 开发过程修复
- **修复**: ImageMagick参数解析错误，解决`create_info_header`函数空文件路径问题

### ✨ 功能改进
- **新增**: 智能阈值自动调整，过高阈值(>0.15)自动调整为0.1，提高检测成功率
- **改进**: 后台进程跟踪和清理机制，增强系统稳定性
- **优化**: 错误处理和进度估算算法，提供更准确的进度反馈
- **增强**: GitHub Actions工作流的中文文件名处理能力

### 🎯 稳定性提升
- **恢复**: 并行场景检测完整功能，确保6/6分段成功完成
- **修复**: 端到端图片生成流程，消除处理失败但报告成功的问题
- **提升**: 整体处理稳定性和用户体验

### 📊 技术改进
- 改进FFmpeg和ImageMagick集成的可靠性
- 优化并行处理的错误恢复机制
- 增强进度监控和状态报告的准确性

## [0.4.1] - 2025-07-26

### 🌐 国际化支持改进

#### 中文文件名支持
- **新增**: URL解码功能，自动处理URL编码的中文文件名
- **新增**: 智能文件名检测，自动识别并解码 `%E4%B8%AD%E6%96%87` 等编码
- **修复**: ImageMagick警告问题，消除 `unknown image property "%8"` 等错误
- **改进**: 预览图头部信息显示，使用可读的中文文件名替代URL编码
- **改进**: 视频信息显示，支持中文、日文等多语言文件名

#### 用户体验优化
- **新增**: 文件名解码状态提示，清晰显示原始和解码后的文件名
- **改进**: 所有文本内容的特殊字符转义，确保ImageMagick兼容性
- **改进**: HTML报告中的文件名显示，使用解码后的可读名称

### 🔧 技术改进
- **新增**: `url_decode()` 函数，使用printf进行高效URL解码
- **新增**: `VIDEO_FILENAME_DISPLAY` 和 `VIDEO_FULL_FILENAME_DISPLAY` 变量
- **改进**: 命令行文本处理，防止特殊字符导致的显示问题
- **修复**: 命令行分割逻辑错误，确保长命令正确换行显示

## [0.4.0] - 2025-07-26

### 🚀 重大性能优化

#### 并行场景检测系统
- **新增**: 分段并行场景检测算法，支持视频分段并行处理
- **新增**: 实时进度监控，显示每个分段的详细处理状态
- **新增**: 智能分段策略，基于CPU核心数和视频时长动态调整
- **新增**: macOS兼容的超时机制，解决timeout命令不存在的问题
- **性能**: 大文件场景检测速度提升3-5倍，有效解决超时问题

#### 进度显示优化
- **新增**: 实时分段进度显示：`总进度:100% [分段0:✓ | 分段1:✓ | ...]`
- **改进**: 0.5秒更新频率，真正的实时进度监控
- **优化**: 清晰的状态标识（✓完成、✗失败、处理中）

### 🔧 算法优化

#### 场景检测策略
- **优化**: 自适应算法选择，大文件优先使用并行算法
- **改进**: 分段策略从固定改为动态（CPU核心数 × 2）
- **优化**: 最小分段时长从5分钟降到3分钟，提高并行度
- **新增**: 完善的回退机制，确保在任何情况下都能完成处理

#### 超时机制重构
- **简化**: 移除冗余的总超时时间，只保留分段超时
- **配置**: `SCENE_DETECTION_SEGMENT_TIMEOUT` 可设为0禁用超时
- **兼容**: 实现macOS兼容的超时控制机制

### 🎯 配置优化

#### Dynamic预设增强
- **新增**: `SCENE_DETECTION_MAX_SEGMENTS=8` 最大分段数配置
- **新增**: `SCENE_DETECTION_SEGMENT_TIMEOUT=0` 分段超时配置
- **优化**: 默认禁用超时，依赖算法自然完成

### 🐛 修复和改进
- **修复**: macOS环境下timeout命令不存在导致的并行算法失败
- **修复**: 分段处理中的环境变量传递问题
- **修复**: ffmpeg路径在子进程中的访问问题
- **改进**: 错误检测和处理逻辑更加精确
- **优化**: 临时文件管理和清理机制

### 📊 性能提升
- **场景检测**: 大文件处理速度提升3-5倍
- **并行度**: 支持最多8个分段同时处理
- **稳定性**: 单个分段失败不影响整体处理
- **兼容性**: 完美支持macOS和Linux环境

### 🔮 实验性功能
- **实现**: 并行分割图生成框架（暂时禁用，避免ImageMagick资源竞争）
- **准备**: 为未来的图片合成并行优化奠定基础

## [0.3.0] - 2025-07-25

### 🎯 新增功能

#### 分批生成系统
- **新增**: `--max-frames-per-part` 参数，支持按帧数分批生成预览图
- **新增**: `--force-split` 参数，强制启用分批生成模式
- **新增**: 智能分批逻辑，自动根据帧数或尺寸限制进行分割
- **新增**: 预设模板内置分批参数，优化不同场景的分批策略

#### Web预览器
- **新增**: `index.html` 发布资源预览器
- **功能**: 支持图片查看、缩放、下载等完整功能
- **特性**: 现代化界面设计，响应式布局
- **集成**: Viewer.js 图片查看器，StreamSaver.js 大文件下载支持

### 🔧 预设优化
- **优化**: Dynamic 预设列数从6调整为5，提升视觉效果
- **新增**: 所有预设模板增加分批生成配置
  - Movie: 每部分最多40帧
  - Lecture: 每部分最多30帧
  - Dynamic: 每部分最多30帧
  - Quick: 使用尺寸限制逻辑(0)

### 🤖 GitHub Actions 改进
- **新增**: `target_repo` 输入参数，支持自定义发布仓库
- **优化**: 工作流更加灵活，不再硬编码目标仓库
- **改进**: Release信息包含目标仓库信息
- **增强**: 更通用的描述文本，适配不同类型的仓库

### 🐛 修复和改进
- **改进**: 分批生成逻辑更加智能，支持多种触发条件
- **优化**: 用户体验提升，更清晰的分批原因提示
- **增强**: 参数验证和错误处理

### 📚 文档更新
- **更新**: README.md 版本信息和新功能说明
- **新增**: 分批生成功能详细文档
- **新增**: Web预览器使用说明
- **更新**: 命令行参数参考表

## [0.2.0] - 2025-07-25

### 🚀 重大改进

#### 模式重命名和优化
- **BREAKING**: 将 `smart` 模式重命名为 `scene` 模式，更明确地表达场景检测功能
- **新增**: 场景检测专门优化算法，性能提升 2-5倍
- **新增**: 关键帧检测专门优化算法，性能提升 2-45倍
- **新增**: 自适应算法选择，根据文件大小自动选择最佳策略

#### 性能优化系统
- **新增**: `detect_scene_changes_optimized()` - 场景检测优化算法
- **新增**: `detect_keyframes_optimized()` - 关键帧检测优化算法
- **新增**: `detect_keyframes_streaming()` - 流式处理算法
- **新增**: `detect_keyframes_parallel()` - 分段并行算法

#### 自适应策略
- **新增**: 根据文件大小自动选择最佳算法
- **策略**: 小文件(原始) → 中等文件(优化) → 大文件(并行) → 超大文件(流式)

#### 智能回退机制
- **新增**: 多层回退策略确保100%兼容性
- **流程**: 流式 → 并行 → 优化 → 原始算法

### 🔧 技术改进
- **新增**: 内存管理和垃圾回收
- **新增**: 性能监控和报告生成
- **新增**: Bash版本兼容性支持

### 📊 性能表现
- **小文件** (<100MB): 使用原始算法避免优化开销
- **中等文件** (100MB-1GB): 2-5倍性能提升
- **大文件** (1GB-2GB): 5-20倍性能提升
- **超大文件** (>2GB): 10-45倍性能提升

### 🐛 修复
- **修复**: Bash版本兼容性问题
- **修复**: 关联数组兼容性问题
- **修复**: 内存监控函数中的变量问题

### 📚 文档更新
- **更新**: README.md 版本信息和功能说明
- **更新**: 模式说明从 `smart` 更新为 `scene`
- **新增**: 性能优化功能详细说明

## [0.1.0] - 2025-07-23

### 新增
- 视频预览生成器首次发布
- 三种捕获模式：时间、智能和关键帧
- 智能场景检测算法
- 高质量捕获的关键帧检测
- 支持自动 CPU 检测的并行处理
- 目录批量处理
- 智能宽度计算和自动分割功能
- 多种输出格式：WebP、JPG、PNG
- 现代/简洁主题的 HTML 报告生成
- 三个优化预设：电影、讲座、快速
- 跨平台部署的 Docker 支持
- 全面的配置管理
- 实时进度指示器
- 智能文件命名，避免冲突

### 技术特性
- 9 个核心模块的模块化架构
- 基于文件大小的动态超时调整
- 性能保护 (20 列限制)
- 智能格式处理和优化
- 增强的标题信息显示
- 每个缩略图的时间戳显示
- 网格间距控制
- 强制覆盖和后缀命名选项

### 文档
- 包含使用示例的全面 README
- API 参考文档
- Docker 部署指南
- 贡献指南
- MIT 许可证

### 依赖
- FFmpeg 用于视频处理
- ImageMagick 用于图像处理
- bc 用于数学计算
- Bash shell 环境
