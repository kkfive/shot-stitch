name: ç”Ÿæˆè§†é¢‘æˆªå›¾

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'è§†é¢‘ URL'
        required: true
        type: string
      preset:
        description: 'é¢„è®¾æ¨¡å¼'
        required: false
        default: 'dynamic'
        type: choice
        options:
        - movie
        - lecture
        - quick
        - dynamic

permissions:
  contents: read

jobs:
  generate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: éªŒè¯è¾“å…¥
      run: |
        if [[ ! "$VIDEO_URL" =~ ^https?:// ]]; then
          echo "âŒ æ— æ•ˆçš„ URL æ ¼å¼"
          exit 1
        fi
        echo "âœ… URL éªŒè¯é€šè¿‡"
      env:
        VIDEO_URL: ${{ inputs.video_url }}
    
    - name: è®¾ç½® Hosts æ˜ å°„
      run: |
        if [ -n "$HOSTS_MAPPING" ]; then
          echo "ğŸ”§ è®¾ç½® hosts æ˜ å°„..."
          echo "$HOSTS_MAPPING" | sudo tee -a /etc/hosts > /dev/null
          echo "âœ… Hosts æ˜ å°„è®¾ç½®å®Œæˆ"
        else
          echo "â„¹ï¸ æœªè®¾ç½® hosts æ˜ å°„ï¼Œè·³è¿‡"
        fi
      env:
        HOSTS_MAPPING: ${{ secrets.HOSTS_MAPPING }}
    
    - name: ä¸‹è½½è§†é¢‘
      run: |
        mkdir -p video_input

        echo "â¬‡ï¸ æ­£åœ¨è·å–è§†é¢‘èµ„æº..."
        echo "ğŸ”— URL: $VIDEO_URL"

        # é¦–å…ˆè·å–æ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“Š è·å–æ–‡ä»¶ä¿¡æ¯..."
        CONTENT_LENGTH=$(curl -sI -L "$VIDEO_URL" | grep -i content-length | tail -1 | cut -d' ' -f2 | tr -d '\r')
        if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
          CONTENT_LENGTH_MB=$((CONTENT_LENGTH / 1024 / 1024))
          echo "ğŸ“ æ–‡ä»¶å¤§å°: ${CONTENT_LENGTH_MB}MB"
        else
          echo "âš ï¸ æ— æ³•è·å–æ–‡ä»¶å¤§å°ä¿¡æ¯"
        fi

        # ä½¿ç”¨ curl ä¸‹è½½ï¼Œæ˜¾ç¤ºå®æ—¶è¿›åº¦
        echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½..."
        if curl -L --fail --progress-bar \
               --connect-timeout 30 --max-time 3600 \
               --user-agent "Mozilla/5.0 (compatible; VideoProcessor/1.0)" \
               --output video_input/video.mp4 \
               --write-out "âœ… ä¸‹è½½å®Œæˆ - å®é™…å¤§å°: %{size_download} å­—èŠ‚ - æ€»ç”¨æ—¶: %{time_total}s - å¹³å‡é€Ÿåº¦: %{speed_download} B/s\n" \
               "$VIDEO_URL"; then

          # éªŒè¯æ–‡ä»¶å¹¶æ˜¾ç¤ºå‹å¥½çš„å¤§å°
          if [ -f video_input/video.mp4 ] && [ -s video_input/video.mp4 ]; then
            FILE_SIZE=$(du -h video_input/video.mp4 | cut -f1)
            FILE_SIZE_BYTES=$(stat -c%s video_input/video.mp4 2>/dev/null || stat -f%z video_input/video.mp4 2>/dev/null)
            echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶å¤§å°: ${FILE_SIZE} (${FILE_SIZE_BYTES} å­—èŠ‚)"

            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆå¦‚æœæœ‰é¢„æœŸå¤§å°ï¼‰
            if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
              if [ "$FILE_SIZE_BYTES" -eq "$CONTENT_LENGTH" ]; then
                echo "âœ… æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡"
              else
                echo "âš ï¸ æ–‡ä»¶å¤§å°ä¸åŒ¹é… (é¢„æœŸ: $CONTENT_LENGTH, å®é™…: $FILE_SIZE_BYTES)"
              fi
            fi
          else
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆæˆ–ä¸ºç©º"
            exit 1
          fi
        else
          echo "âŒ è§†é¢‘ä¸‹è½½å¤±è´¥"
          exit 1
        fi
      env:
        VIDEO_URL: ${{ inputs.video_url }}
    
    - name: ç”Ÿæˆæˆªå›¾
      run: |
        echo "ğŸ¬ å¼€å§‹ç”Ÿæˆæˆªå›¾..."
        
        # ä» URL ä¸­æå–æ–‡ä»¶å
        VIDEO_FILENAME=$(echo "$VIDEO_URL" | sed 's/.*\///' | sed 's/\?.*$//' | sed 's/\.[^.]*$//')
        if [ -z "$VIDEO_FILENAME" ]; then
          VIDEO_FILENAME="video_$(date +%Y%m%d_%H%M%S)"
        fi
        VIDEO_FILENAME=$(echo "$VIDEO_FILENAME" | sed 's/[^a-zA-Z0-9_-]/_/g' | sed 's/__*/_/g' | sed 's/^_\|_$//g')
        
        echo "ğŸ“ è§†é¢‘æ–‡ä»¶å: $VIDEO_FILENAME"
        echo "VIDEO_FILENAME=$VIDEO_FILENAME" >> $GITHUB_ENV
        
        # è¿è¡Œ shot-stitch Docker å®¹å™¨
        docker run --rm \
          -v $(pwd)/video_input:/data \
          dreamytzk/shot-stitch:latest \
          /data/video.mp4 \
          --preset ${{ inputs.preset }} \
          --html \
          --force
        
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        SCREENSHOT_COUNT=$(find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "video.mp4" | wc -l)
        
        if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•æˆªå›¾æ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ… æˆªå›¾ç”Ÿæˆå®Œæˆï¼Œå…±ç”Ÿæˆ $SCREENSHOT_COUNT ä¸ªæ–‡ä»¶"
        
        # åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        echo "ğŸ“Š ç”Ÿæˆçš„æ–‡ä»¶:"
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "video.mp4" | while read file; do
          echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
        done
      env:
        VIDEO_URL: ${{ inputs.video_url }}
    
    - name: å‡†å¤‡ Release ä¿¡æ¯
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        RELEASE_TAG="screenshots-${TIMESTAMP}"
        RELEASE_NAME="$VIDEO_FILENAME æˆªå›¾ - $(date '+%Y-%m-%d %H:%M:%S')"
        
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
        
        # åˆ›å»º Release æè¿°
        echo "# è§†é¢‘æˆªå›¾æ–‡ä»¶" > release_notes.md
        echo "" >> release_notes.md
        echo "**è§†é¢‘æ–‡ä»¶å**: \`$VIDEO_FILENAME\`" >> release_notes.md
        echo "**é¢„è®¾æ¨¡å¼**: \`${{ inputs.preset }}\`" >> release_notes.md
        echo "**ç”Ÿæˆæ—¶é—´**: \`$(date '+%Y-%m-%d %H:%M:%S')\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## åŒ…å«æ–‡ä»¶" >> release_notes.md
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "video.mp4" | while read file; do
          echo "- \`$(basename "$file")\` ($(du -h "$file" | cut -f1))" >> release_notes.md
        done
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> release_notes.md
        
        echo "âœ… Release ä¿¡æ¯å‡†å¤‡å®Œæˆ"
    
    - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      run: |
        echo "ğŸš€ åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶..."
        
        # åˆ›å»º Release
        gh release create "$RELEASE_TAG" \
          --repo "kkfive-action/private-screenshots" \
          --title "$RELEASE_NAME" \
          --notes-file release_notes.md
        
        echo "âœ… Release åˆ›å»ºæˆåŠŸ: $RELEASE_TAG"
        
        # ä¸Šä¼ æ‰€æœ‰æˆªå›¾æ–‡ä»¶
        echo "ğŸ“¤ ä¸Šä¼ æˆªå›¾æ–‡ä»¶..."
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "video.mp4" | while read file; do
          filename=$(basename "$file")
          echo "ğŸ“¤ ä¸Šä¼ : $filename"
          
          gh release upload "$RELEASE_TAG" "$file" \
            --repo "kkfive-action/private-screenshots" \
            --clobber
        done
        
        echo "âœ… æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
        echo "RELEASE_URL=https://github.com/kkfive-action/private-screenshots/releases/tag/$RELEASE_TAG" >> $GITHUB_ENV
      env:
        GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
    
    - name: ç”Ÿæˆä¸‹è½½ä¿¡æ¯
      run: |
        echo "ğŸ‰ æˆªå›¾å·²æˆåŠŸä¸Šä¼ åˆ°ç§æœ‰ä»“åº“!"
        echo ""
        echo "ğŸ“ ç§æœ‰ä»“åº“: kkfive-action/private-screenshots"
        echo "ğŸ·ï¸  Release æ ‡ç­¾: $RELEASE_TAG"
        echo "ğŸ”— Release é“¾æ¥: $RELEASE_URL"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
        echo "1. è®¿é—®ç§æœ‰ä»“åº“çš„ Releases é¡µé¢"
        echo "2. æ‰¾åˆ°æ ‡ç­¾ä¸º '$RELEASE_TAG' çš„ Release"
        echo "3. ç›´æ¥ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼ˆæ— éœ€è§£å‹ï¼‰"
        echo ""
        echo "ğŸ“Š å¯ä¸‹è½½çš„æ–‡ä»¶:"
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "video.mp4" | while read file; do
          echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
        done
        echo ""
        echo "ğŸ”’ åªæœ‰ç§æœ‰ä»“åº“çš„åä½œè€…å¯ä»¥è®¿é—®å’Œä¸‹è½½"
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf video_input/ release_notes.md
        echo "âœ… æ¸…ç†å®Œæˆ"
