<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘å¸ƒèµ„æºé¢„è§ˆå™¨ - Shot Stitch v0.3.0</title>
    <!-- Viewer.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.css">
    <!-- StreamSaver.js for large file handling -->
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6; color: #333; background: #f5f7fa;
            min-height: 100vh;
            overflow-y: scroll; /* å§‹ç»ˆæ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ï¼Œé˜²æ­¢é—ªåŠ¨ */
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px 0; text-align: center; margin-bottom: 30px;
            border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 2.2em; margin-bottom: 8px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            position: sticky;
            top: 20px;
        }
        
        .input-section {
            margin-bottom: 25px;
        }
        
        .input-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #6c757d;
        }

        .input-group select option {
            padding: 8px;
        }

        /* èµ„æºé€‰æ‹©å™¨ä½œä¸ºæ ‡é¢˜æ ·å¼ */
        .asset-selector {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            border-bottom: 1px solid #d1e7ff;
        }

        .asset-selector-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }

        .download-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .download-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #assetSelect {
            flex: 1;
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            padding: 12px;
            font-weight: 500;
            font-size: 14px;
            min-width: 0; /* å…è®¸æ”¶ç¼© */
        }

        #assetSelect:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }



        /* é¢„è§ˆåŒºåŸŸloadingåŠ¨ç”» */
        .preview-loading {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .preview-area {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            min-height: 600px; /* å¢åŠ æœ€å°é«˜åº¦ */
            display: flex;
            flex-direction: column;
        }
        
        .preview-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            flex: 1;
            min-width: 0; /* å…è®¸flexé¡¹ç›®æ”¶ç¼©åˆ°å†…å®¹å®½åº¦ä»¥ä¸‹ */

            /* æ–‡æœ¬æˆªæ–­æ ·å¼ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;

            /* æ‚¬æµ®æç¤º */
            cursor: help;
        }
        


        /* è‡ªå®šä¹‰Viewer.jsæ ·å¼ */
        .viewer-container {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .viewer-title {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .preview-content {
            padding: 30px;
            text-align: center;
            min-height: 500px; /* å›ºå®šæœ€å°é«˜åº¦ï¼Œé˜²æ­¢é—ªåŠ¨ */
            flex: 1; /* å ç”¨å‰©ä½™ç©ºé—´ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: auto; /* å†…å®¹æº¢å‡ºæ—¶æ»šåŠ¨ */
        }
        
        .preview-placeholder {
            color: #6c757d;
            font-size: 1.1em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .preview-placeholder .icon {
            font-size: 3em;
            opacity: 0.5;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .preview-image:hover {
            transform: scale(1.02);
        }
        

        
        .loading {
            display: none;
            color: #667eea;
            font-size: 1.1em;
        }
        

        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .control-panel {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–¼ï¸ å‘å¸ƒèµ„æºé¢„è§ˆå™¨</h1>
            <p>é¢„è§ˆä½ çš„è§†é¢‘æˆªå›¾å’Œå‘å¸ƒèµ„æº - Shot Stitch v0.3.0</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('url')">ğŸ”— URL</div>
                    <div class="tab" onclick="switchTab('github')">ğŸ“ GitHub</div>
                </div>

                <!-- URLè¾“å…¥æ ‡ç­¾é¡µ -->
                <div id="url-tab" class="tab-content active">
                    <div class="input-section">
                        <h3>ğŸ”— å›¾ç‰‡URLé¢„è§ˆ</h3>
                        <div class="input-group">
                            <label for="imageUrl">å›¾ç‰‡é“¾æ¥</label>
                            <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg">
                        </div>
                        <button class="btn" onclick="loadImageFromUrl()">åŠ è½½é¢„è§ˆ</button>
                    </div>
                </div>

                <!-- GitHubè¾“å…¥æ ‡ç­¾é¡µ -->
                <div id="github-tab" class="tab-content">
                    <div class="input-section">
                        <h3>ğŸ“ GitHubå‘å¸ƒé¢„è§ˆ</h3>
                        <div class="input-group">
                            <label for="githubToken">GitHub Token (æ¨è)</label>
                            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                        </div>


                        <div class="input-group">
                            <label for="repoOwner">ä»“åº“æ‰€æœ‰è€…</label>
                            <input type="text" id="repoOwner" placeholder="username">
                        </div>
                        <div class="input-group">
                            <label for="repoName">ä»“åº“åç§°</label>
                            <input type="text" id="repoName" placeholder="repository-name">
                        </div>
                        <button class="btn" onclick="loadGitHubReleases()">è·å–å‘å¸ƒåˆ—è¡¨</button>

                        <div class="input-group" id="releaseSelectGroup" style="display: none;">
                            <label for="releaseSelect">é€‰æ‹©å‘å¸ƒç‰ˆæœ¬</label>
                            <select id="releaseSelect" onchange="onReleaseSelected()">
                                <option value="">è¯·é€‰æ‹©å‘å¸ƒç‰ˆæœ¬...</option>
                            </select>
                        </div>




                    </div>
                </div>



                <div class="loading" id="loading">
                    â³ åŠ è½½ä¸­...
                </div>
            </div>

            <div class="preview-area">
                <!-- GitHubèµ„æºé€‰æ‹©å™¨ä½œä¸ºæ ‡é¢˜ -->
                <div class="preview-header asset-selector" id="assetSelectGroup" style="display: none;">
                    <div class="asset-selector-content">
                        <select id="assetSelect" onchange="onAssetSelected()">
                            <option value="">ğŸ“· é€‰æ‹©å›¾ç‰‡æ–‡ä»¶...</option>
                        </select>
                        <button class="download-btn" onclick="downloadCurrentAsset()" id="downloadAssetBtn" disabled title="ä¸‹è½½å›¾ç‰‡">ğŸ“¥ ä¸‹è½½</button>
                    </div>
                </div>

                <!-- é»˜è®¤æ ‡é¢˜ï¼ˆæ— é€‰æ‹©å™¨æ—¶æ˜¾ç¤ºï¼‰ -->
                <div class="preview-header" id="defaultHeader">
                    <div class="preview-title">é¢„è§ˆåŒºåŸŸ</div>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="preview-placeholder">
                        <div class="icon">ğŸ–¼ï¸</div>
                        <div>é€‰æ‹©å›¾ç‰‡URLæˆ–GitHubä»“åº“å¼€å§‹é¢„è§ˆ</div>
                        <div style="font-size: 0.9em; opacity: 0.7;">æ”¯æŒ JPG, PNG, WebP, GIF ç­‰æ ¼å¼</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.js"></script>
    <script>
        let currentImage = null;
        let githubReleases = [];
        let selectedRelease = null;
        let releaseAssets = [];
        let viewer = null;

        // ç¼“å­˜å’Œç«æ€æ§åˆ¶
        let imageCache = new Map(); // å›¾ç‰‡ç¼“å­˜
        let currentLoadingRequest = null; // å½“å‰åŠ è½½è¯·æ±‚çš„æ ‡è¯†
        let requestCounter = 0; // è¯·æ±‚è®¡æ•°å™¨

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // ç®€åŒ–çš„é”™è¯¯å¤„ç†ï¼ˆä»…åœ¨æ§åˆ¶å°è¾“å‡ºï¼‰
        function showError(message) {
            console.error('Error:', message);
            hideLoading();
        }

        // ç®€åŒ–çš„æˆåŠŸå¤„ç†ï¼ˆä»…åœ¨æ§åˆ¶å°è¾“å‡ºï¼‰
        function showSuccess(message) {
            console.log('Success:', message);
            hideLoading();
        }

        // åœ¨é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºloadingçŠ¶æ€
        function showPreviewLoading(filename, requestId) {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = `
                <div class="preview-placeholder preview-loading">
                    <div class="icon" style="font-size: 4em;">â³</div>
                    <div class="text" style="font-size: 18px; margin: 20px 0;">æ­£åœ¨åŠ è½½å›¾ç‰‡...</div>
                    <div style="color: #667eea; font-size: 14px; font-weight: 500;">
                        ğŸ“· ${filename}
                    </div>
                    <div style="margin-top: 15px; color: #999; font-size: 12px;">
                        è¯·ç¨å€™ï¼Œæ­£åœ¨ä»GitHubè·å–èµ„æº... (è¯·æ±‚ID: ${requestId})
                    </div>
                </div>
            `;


        }

        // æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆè§£å†³ç«æ€é—®é¢˜ï¼‰
        function isRequestValid(requestId) {
            return currentLoadingRequest === requestId;
        }

        // æ˜¾ç¤ºç¼“å­˜çš„å›¾ç‰‡
        function displayCachedImage(cachedImage) {
            currentImage = cachedImage;

            const previewContent = document.getElementById('previewContent');


            previewContent.innerHTML = `
                <div class="image-container">
                    <img src="${cachedImage.url}" alt="é¢„è§ˆå›¾ç‰‡" class="preview-image" id="previewImg" data-original="${cachedImage.url}">
                </div>
            `;

            hideLoading();
            showSuccess(`å›¾ç‰‡åŠ è½½æˆåŠŸï¼(ä»ç¼“å­˜)\næ–‡ä»¶: ${cachedImage.filename}\nå¤§å°: ${cachedImage.size}`);
            enableControls();
            initViewer();
        }

        // å°†å›¾ç‰‡æ·»åŠ åˆ°ç¼“å­˜
        function addToCache(asset, imageData) {
            const cacheKey = `${asset.id}_${asset.name}`;
            imageCache.set(cacheKey, imageData);
        }

        // æ¸…é™¤å›¾ç‰‡ç¼“å­˜
        function clearImageCache() {
            imageCache.clear();
        }



        // ä»URLåŠ è½½å›¾ç‰‡
        function loadImageFromUrl() {
            const url = document.getElementById('imageUrl').value.trim();
            
            if (!url) {
                showError('è¯·è¾“å…¥å›¾ç‰‡URL');
                return;
            }

            if (!isValidImageUrl(url)) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URL');
                return;
            }

            showLoading();
            loadImage(url);
        }

        // éªŒè¯å›¾ç‰‡URLæˆ–æ–‡ä»¶å
        function isValidImageUrl(urlOrFilename) {
            // å¦‚æœæ˜¯å®Œæ•´URLï¼ŒéªŒè¯URLæ ¼å¼
            try {
                new URL(urlOrFilename);
                return /\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i.test(urlOrFilename);
            } catch {
                // å¦‚æœä¸æ˜¯URLï¼Œå½“ä½œæ–‡ä»¶åå¤„ç†
                return /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(urlOrFilename);
            }
        }

        // åŠ è½½å›¾ç‰‡
        function loadImage(url, filename = '') {
            const img = new Image();
            
            img.onload = function() {
                currentImage = {
                    url: url,
                    filename: filename || getFilenameFromUrl(url),
                    width: this.naturalWidth,
                    height: this.naturalHeight,
                    size: 'Unknown'
                };
                
                displayImage(this);
                hideLoading();
                showSuccess('å›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                enableControls();
            };
            
            img.onerror = function() {
                showError('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®');
            };
            
            img.src = url;
        }

        // ä»URLè·å–æ–‡ä»¶å
        function getFilenameFromUrl(url) {
            try {
                const pathname = new URL(url).pathname;
                return pathname.split('/').pop() || 'image';
            } catch {
                return 'image';
            }
        }



        // æ˜¾ç¤ºå›¾ç‰‡
        function displayImage(img) {
            const previewContent = document.getElementById('previewContent');
            const previewTitle = document.getElementById('previewTitle');

            previewContent.innerHTML = `
                <div class="image-container">
                    <img src="${img.src}" alt="é¢„è§ˆå›¾ç‰‡" class="preview-image" id="previewImg" data-original="${img.src}">
                </div>
            `;



            // åˆå§‹åŒ–Viewer.js
            initViewer();
        }

        // åˆå§‹åŒ–Viewer.js
        function initViewer() {
            const imageElement = document.getElementById('previewImg');
            if (imageElement && viewer) {
                viewer.destroy();
            }

            if (imageElement) {
                viewer = new Viewer(imageElement, {
                    inline: false,
                    button: true,
                    navbar: false,
                    title: function(image) {
                        return currentImage ? currentImage.filename : '';
                    },
                    toolbar: {
                        zoomIn: 1,
                        zoomOut: 1,
                        oneToOne: 1,
                        reset: 1,
                        prev: 0,
                        play: 0,
                        next: 0,
                        rotateLeft: 1,
                        rotateRight: 1,
                        flipHorizontal: 1,
                        flipVertical: 1
                    },
                    tooltip: true,
                    movable: true,
                    zoomable: true,
                    rotatable: true,
                    scalable: true,
                    transition: true,
                    fullscreen: true,
                    keyboard: true,
                    backdrop: true,
                    loading: true,
                    loop: false,
                    interval: 5000,
                    minWidth: 200,
                    minHeight: 100,
                    zoomRatio: 0.1,
                    minZoomRatio: 0.01,
                    maxZoomRatio: 100,
                    zIndex: 2015,
                    zIndexInline: 0,
                    url: 'data-original',
                    container: document.body,
                    filter: null,
                    toggleOnDblclick: true,
                    ready: function() {},
                    show: function() {},
                    shown: function() {},
                    hide: function() {},
                    hidden: function() {}
                });
            }
        }

        // å¯ç”¨æ§åˆ¶æŒ‰é’®
        function enableControls() {
            const downloadBtn = document.getElementById('downloadAssetBtn');
            if (downloadBtn) downloadBtn.disabled = false;
        }

        // ç¦ç”¨æ§åˆ¶æŒ‰é’®
        function disableControls() {
            const downloadBtn = document.getElementById('downloadAssetBtn');
            if (downloadBtn) downloadBtn.disabled = true;
        }

        // ä¸‹è½½å½“å‰é€‰ä¸­çš„èµ„æºï¼ˆè·³è½¬åˆ°GitHubä¸‹è½½é“¾æ¥ï¼‰
        function downloadCurrentAsset() {
            const assetSelect = document.getElementById('assetSelect');
            const selectedIndex = assetSelect.value;

            if (selectedIndex === '' || !releaseAssets[selectedIndex]) {
                showError('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            const asset = releaseAssets[selectedIndex];
            // ç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€GitHubçš„ä¸‹è½½é“¾æ¥
            window.open(asset.browser_download_url, '_blank');
            showSuccess(`å¼€å§‹ä¸‹è½½: ${asset.name}`);
        }







        // æ¸…ç©ºé¢„è§ˆ
        function clearPreview() {
            const previewContent = document.getElementById('previewContent');
            const previewTitle = document.getElementById('previewTitle');

            // æ¸…ç†blob URLï¼Œé¿å…å†…å­˜æ³„æ¼
            if (currentImage) {
                if (currentImage.blobUrl && currentImage.isBlobUrl) {
                    URL.revokeObjectURL(currentImage.blobUrl);
                }
                // Data URLä¸éœ€è¦æ¸…ç†ï¼Œä¼šè¢«åƒåœ¾å›æ”¶å™¨è‡ªåŠ¨å¤„ç†
            }

            previewContent.innerHTML = `
                <div class="preview-placeholder">
                    <div class="icon">ğŸ–¼ï¸</div>
                    <div>é€‰æ‹©å›¾ç‰‡URLæˆ–GitHubä»“åº“å¼€å§‹é¢„è§ˆ</div>
                    <div style="font-size: 0.9em; opacity: 0.7;">æ”¯æŒ JPG, PNG, WebP, GIF ç­‰æ ¼å¼</div>
                </div>
            `;


            currentImage = null;

            // é”€æ¯viewerå®ä¾‹
            if (viewer) {
                viewer.destroy();
                viewer = null;
            }

            disableControls();
        }

        // GitHubå‘å¸ƒç›¸å…³åŠŸèƒ½
        function loadGitHubReleases() {
            // æ¸…ç©ºç¼“å­˜
            clearImageCache();

            const token = document.getElementById('githubToken').value.trim();
            const owner = document.getElementById('repoOwner').value.trim();
            const repo = document.getElementById('repoName').value.trim();

            if (!owner || !repo) {
                showError('è¯·è¾“å…¥ä»“åº“æ‰€æœ‰è€…å’Œä»“åº“åç§°');
                return;
            }

            showLoading();

            // æ„å»ºGitHub Releases API URL
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/releases`;

            const headers = {
                'Accept': 'application/vnd.github.v3+json'
            };

            if (token) {
                headers['Authorization'] = `bearer ${token}`;
            }

            fetch(apiUrl, { headers })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error(`ä»“åº“ä¸å­˜åœ¨ã€æ— è®¿é—®æƒé™æˆ–æ²¡æœ‰å‘å¸ƒç‰ˆæœ¬\n\nè¯·æ£€æŸ¥:\n1. ä»“åº“åç§°æ˜¯å¦æ­£ç¡®: ${owner}/${repo}\n2. ä»“åº“æ˜¯å¦ä¸ºå…¬å¼€ä»“åº“\n3. ä»“åº“æ˜¯å¦æœ‰å‘å¸ƒç‰ˆæœ¬(releases)\n4. å¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼Œè¯·æä¾›æœ‰æ•ˆçš„GitHub Token`);
                        } else if (response.status === 403) {
                            throw new Error('APIè®¿é—®å—é™\n\nå¯èƒ½åŸå› :\n1. APIè°ƒç”¨é¢‘ç‡é™åˆ¶\n2. éœ€è¦GitHub Tokenè®¿é—®ç§æœ‰ä»“åº“\n3. Tokenæƒé™ä¸è¶³\n\nå»ºè®®: ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•ï¼Œæˆ–æä¾›æœ‰æ•ˆçš„GitHub Token');
                        }
                        throw new Error(`GitHub APIé”™è¯¯: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        showError('è¯¥ä»“åº“æ²¡æœ‰å‘å¸ƒç‰ˆæœ¬');
                        return;
                    }

                    githubReleases = data;
                    populateReleaseSelect();
                    hideLoading();
                    showSuccess(`æ‰¾åˆ° ${data.length} ä¸ªå‘å¸ƒç‰ˆæœ¬`);
                })
                .catch(error => {
                    showError('è·å–GitHubå‘å¸ƒå¤±è´¥: ' + error.message);
                });
        }

        function populateReleaseSelect() {
            const releaseSelect = document.getElementById('releaseSelect');
            const releaseSelectGroup = document.getElementById('releaseSelectGroup');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            releaseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å‘å¸ƒç‰ˆæœ¬...</option>';

            // æ·»åŠ å‘å¸ƒé€‰é¡¹
            githubReleases.forEach((release, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${release.tag_name} - ${release.name || 'æœªå‘½å'} ${release.prerelease ? '(é¢„å‘å¸ƒ)' : ''}`;
                releaseSelect.appendChild(option);
            });

            // æ˜¾ç¤ºå‘å¸ƒé€‰æ‹©å™¨
            releaseSelectGroup.style.display = 'block';
        }

        function onReleaseSelected() {
            const releaseSelect = document.getElementById('releaseSelect');
            const selectedIndex = releaseSelect.value;

            if (selectedIndex === '') {
                hideAssetSelect();
                return;
            }

            selectedRelease = githubReleases[selectedIndex];

            // è¿‡æ»¤å›¾ç‰‡èµ„æº
            releaseAssets = selectedRelease.assets.filter(asset =>
                /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(asset.name)
            );

            if (releaseAssets.length === 0) {
                const allAssetNames = selectedRelease.assets.map(a => a.name).join(', ');
                showError(`è¯¥å‘å¸ƒç‰ˆæœ¬ä¸­æ²¡æœ‰å›¾ç‰‡èµ„æº\n\nå¯ç”¨æ–‡ä»¶: ${allAssetNames || 'æ— æ–‡ä»¶'}\n\næ”¯æŒçš„å›¾ç‰‡æ ¼å¼: JPG, PNG, GIF, WebP, BMP, SVG`);
                hideAssetSelect();
                return;
            }

            populateAssetSelect();
            if (releaseAssets.length === 1) {
                showSuccess(`å‘å¸ƒ ${selectedRelease.tag_name} ä¸­æ‰¾åˆ° 1 ä¸ªå›¾ç‰‡èµ„æºï¼Œå·²è‡ªåŠ¨é¢„è§ˆ`);
            } else {
                showSuccess(`å‘å¸ƒ ${selectedRelease.tag_name} ä¸­æ‰¾åˆ° ${releaseAssets.length} ä¸ªå›¾ç‰‡èµ„æºï¼Œè¯·é€‰æ‹©è¦é¢„è§ˆçš„å›¾ç‰‡`);
            }
        }

        function populateAssetSelect() {
            const assetSelect = document.getElementById('assetSelect');
            const assetSelectGroup = document.getElementById('assetSelectGroup');
            const defaultHeader = document.getElementById('defaultHeader');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            assetSelect.innerHTML = '<option value="">ï¿½ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶...</option>';

            // æ·»åŠ èµ„æºé€‰é¡¹ï¼Œä¿å­˜assetçš„å®Œæ•´ä¿¡æ¯
            releaseAssets.forEach((asset, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.dataset.assetId = asset.id; // ä¿å­˜asset ID
                option.dataset.assetUrl = asset.url; // ä¿å­˜asset API URL
                const sizeText = formatFileSize(asset.size);
                option.textContent = `${asset.name} (${sizeText})`;
                assetSelect.appendChild(option);
            });

            // æ˜¾ç¤ºèµ„æºé€‰æ‹©å™¨ï¼Œéšè—é»˜è®¤æ ‡é¢˜
            assetSelectGroup.style.display = 'block';
            defaultHeader.style.display = 'none';

            // å¦‚æœåªæœ‰ä¸€ä¸ªå›¾ç‰‡ï¼Œè‡ªåŠ¨é€‰æ‹©å¹¶é¢„è§ˆ
            if (releaseAssets.length === 1) {
                assetSelect.value = '0';
                onAssetSelected();
            }
        }

        function onAssetSelected() {
            const assetSelect = document.getElementById('assetSelect');
            const selectedIndex = assetSelect.value;

            if (selectedIndex !== '' && releaseAssets[selectedIndex]) {
                const asset = releaseAssets[selectedIndex];
                const cacheKey = `${asset.id}_${asset.name}`;

                // æ£€æŸ¥ç¼“å­˜
                if (imageCache.has(cacheKey)) {
                    console.log('ä»ç¼“å­˜åŠ è½½å›¾ç‰‡:', asset.name);
                    const cachedImage = imageCache.get(cacheKey);
                    displayCachedImage(cachedImage);
                    return;
                }

                // ç«‹å³é¢„è§ˆé€‰ä¸­çš„èµ„æº
                previewSelectedAsset();
            } else {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œæ¸…ç©ºé¢„è§ˆåŒºåŸŸ
                clearPreview();
            }
        }

        function previewSelectedAsset() {
            const assetSelect = document.getElementById('assetSelect');
            const selectedIndex = assetSelect.value;

            if (selectedIndex === '' || !releaseAssets[selectedIndex]) {
                return; // é™é»˜è¿”å›ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
            }

            const asset = releaseAssets[selectedIndex];
            const token = document.getElementById('githubToken').value.trim();

            // ç”Ÿæˆæ–°çš„è¯·æ±‚IDï¼Œç”¨äºç«æ€æ§åˆ¶
            const requestId = ++requestCounter;
            currentLoadingRequest = requestId;

            // åœ¨é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºloadingçŠ¶æ€
            showPreviewLoading(asset.name, requestId);

            // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡æ–‡ä»¶
            if (!isValidImageUrl(asset.name)) {
                showError('é€‰ä¸­çš„æ–‡ä»¶ä¸æ˜¯æ”¯æŒçš„å›¾ç‰‡æ ¼å¼');
                return;
            }



            // æ£€æŸ¥ç¯å¢ƒå’Œtokenæƒ…å†µï¼Œé€‰æ‹©æœ€ä½³åŠ è½½æ–¹å¼
            const isHttpContext = window.location.protocol === 'http:';
            const isFileContext = window.location.protocol === 'file:';

            if (token && !isHttpContext) {
                // æœ‰tokenä¸”éHTTPç¯å¢ƒï¼šä¼˜å…ˆä½¿ç”¨GitHub Assets API
                loadAssetWithAPI(asset, token, requestId);
            } else if (isHttpContext && token) {
                // HTTPç¯å¢ƒä¸‹å³ä½¿æœ‰tokenä¹Ÿå¯èƒ½é‡åˆ°CORSé—®é¢˜ï¼Œå…ˆå°è¯•APIï¼Œå¤±è´¥åè‡ªåŠ¨å›é€€
                loadAssetWithAPI(asset, token, requestId);
            } else {
                // æ— tokenæˆ–file://ç¯å¢ƒï¼šä½¿ç”¨é‡å®šå‘URLæ–¹æ³•
                tryRedirectUrlWithContentType(asset, requestId);
            }
        }

        // è·å–é‡å®šå‘URLå¹¶ä¿®æ”¹content-typeå‚æ•°ï¼ˆå·§å¦™æ–¹æ¡ˆï¼‰
        function tryRedirectUrlWithContentType(asset, requestId) {
            showLoading();

            // åœ¨HTTPç¯å¢ƒä¸‹ï¼Œç›´æ¥ä½¿ç”¨browser_download_urlè€Œä¸æ˜¯API URL
            const isHttpContext = window.location.protocol === 'http:';
            const urlToTry = isHttpContext ? asset.browser_download_url : asset.url;

            // å…ˆè·å–é‡å®šå‘çš„æœ€ç»ˆURL
            fetch(urlToTry, {
                method: 'HEAD', // åªè·å–å¤´éƒ¨ä¿¡æ¯ï¼Œä¸ä¸‹è½½å†…å®¹
                redirect: 'follow' // è·Ÿéšé‡å®šå‘
            })
            .then(response => {
                // æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                if (!isRequestValid(requestId)) {
                    console.log('è¯·æ±‚å·²è¿‡æœŸï¼Œå¿½ç•¥é‡å®šå‘å“åº”:', requestId);
                    return;
                }

                const finalUrl = response.url;

                if (finalUrl && finalUrl !== urlToTry) {
                    // ä¿®æ”¹URLä¸­çš„response-content-typeå‚æ•°
                    const modifiedUrl = modifyContentTypeInUrl(finalUrl, asset.name);
                    // ä½¿ç”¨ä¿®æ”¹åçš„URLåŠ è½½å›¾ç‰‡
                    loadImageFromModifiedUrl(modifiedUrl, asset, requestId);
                } else {
                    // æ²¡æœ‰é‡å®šå‘ï¼Œå›é€€åˆ°åŸæ–¹æ¡ˆ
                    tryDirectUrlWithCorsHandling(asset, requestId);
                }
            })
            .catch(error => {
                // æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                if (!isRequestValid(requestId)) {
                    console.log('è¯·æ±‚å·²è¿‡æœŸï¼Œå¿½ç•¥é”™è¯¯:', requestId);
                    return;
                }
                // å›é€€åˆ°åŸæ–¹æ¡ˆ
                tryDirectUrlWithCorsHandling(asset, requestId);
            });
        }

        // ä¿®æ”¹URLä¸­çš„response-content-typeå‚æ•°
        function modifyContentTypeInUrl(url, filename) {
            try {
                const urlObj = new URL(url);

                // æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®šæ­£ç¡®çš„MIMEç±»å‹
                const extension = filename.toLowerCase().split('.').pop();
                const mimeTypes = {
                    'jpg': 'image/jpeg',
                    'jpeg': 'image/jpeg',
                    'png': 'image/png',
                    'gif': 'image/gif',
                    'webp': 'image/webp',
                    'bmp': 'image/bmp',
                    'svg': 'image/svg+xml'
                };

                const correctMimeType = mimeTypes[extension] || 'image/jpeg';

                // ä¿®æ”¹response-content-typeå‚æ•°
                urlObj.searchParams.set('response-content-type', correctMimeType);
                return urlObj.toString();
            } catch (error) {
                return url; // è¿”å›åŸURL
            }
        }

        // ä½¿ç”¨ä¿®æ”¹åçš„URLåŠ è½½å›¾ç‰‡
        function loadImageFromModifiedUrl(url, asset) {
            const img = new Image();
            img.crossOrigin = 'anonymous';

            img.onload = function() {
                currentImage = {
                    url: url,
                    filename: asset.name + ' (ä¿®æ”¹Content-Type)',
                    width: this.naturalWidth,
                    height: this.naturalHeight,
                    size: formatFileSize(asset.size),
                    isModifiedUrl: true
                };

                displayImage(this);
                hideLoading();
                showSuccess(`å›¾ç‰‡åŠ è½½æˆåŠŸï¼\næ–‡ä»¶: ${asset.name}\nå¤§å°: ${formatFileSize(asset.size)}\n\né€šè¿‡ä¿®æ”¹Content-Typeå‚æ•°è§£å†³è·¨åŸŸé—®é¢˜ï¼`);
                enableControls();
            };

            img.onerror = function() {
                // å°è¯•ä¸å¸¦CORS
                const img2 = new Image();
                img2.onload = function() {
                    currentImage = {
                        url: url,
                        filename: asset.name + ' (ä¿®æ”¹Content-Type)',
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        size: formatFileSize(asset.size),
                        isModifiedUrl: true
                    };

                    displayImage(this);
                    hideLoading();
                    showSuccess(`å›¾ç‰‡åŠ è½½æˆåŠŸï¼\næ–‡ä»¶: ${asset.name}\nå¤§å°: ${formatFileSize(asset.size)}\n\né€šè¿‡ä¿®æ”¹Content-Typeå‚æ•°è§£å†³é—®é¢˜ï¼`);
                    enableControls();
                };

                img2.onerror = function() {
                    // å›é€€åˆ°åŸæ¥çš„è·¨åŸŸå¤„ç†æ–¹æ¡ˆ
                    tryDirectUrlWithCorsHandling(asset);
                };

                img2.src = url;
            };

            img.src = url;
        }

        // å¤„ç†æ— tokenæƒ…å†µä¸‹çš„è·¨åŸŸé—®é¢˜ï¼ˆåŸæ–¹æ¡ˆä½œä¸ºå›é€€ï¼‰
        function tryDirectUrlWithCorsHandling(asset) {
            // æ–¹æ³•1: å°è¯•ç›´æ¥åŠ è½½ï¼ˆå¯èƒ½æˆåŠŸï¼Œå–å†³äºGitHubçš„CORSç­–ç•¥ï¼‰
            const img = new Image();
            img.crossOrigin = 'anonymous';

            img.onload = function() {
                currentImage = {
                    url: asset.browser_download_url,
                    filename: asset.name,
                    width: this.naturalWidth,
                    height: this.naturalHeight,
                    size: formatFileSize(asset.size),
                    isDirectUrl: true
                };

                displayImage(this);
                hideLoading();
                showSuccess(`å›¾ç‰‡åŠ è½½æˆåŠŸï¼\næ–‡ä»¶: ${asset.name}\nå¤§å°: ${formatFileSize(asset.size)}\n\nç›´æ¥URLæ–¹å¼`);
                enableControls();
            };

            img.onerror = function(event) {
                // æ–¹æ³•2: ä¸è®¾ç½®crossOriginå†è¯•ä¸€æ¬¡
                const img2 = new Image();

                img2.onload = function() {
                    currentImage = {
                        url: asset.browser_download_url,
                        filename: asset.name,
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        size: formatFileSize(asset.size),
                        isDirectUrl: true
                    };

                    displayImage(this);
                    hideLoading();
                    showSuccess(`å›¾ç‰‡åŠ è½½æˆåŠŸï¼\næ–‡ä»¶: ${asset.name}\nå¤§å°: ${formatFileSize(asset.size)}\n\nç›´æ¥URLæ–¹å¼ï¼ˆæ— CORSï¼‰`);
                    enableControls();
                };

                img2.onerror = function() {
                    hideLoading();
                    showError(`æ— æ³•åŠ è½½å›¾ç‰‡: ${asset.name}\n\nè·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆ:\n1. âœ… æä¾›GitHub Tokenï¼ˆæ¨èï¼‰\n2. ğŸ”§ ä½¿ç”¨HTTPSæœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢\n3. ğŸ”§ ä½¿ç”¨file://åè®®ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶\n4. ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ç¦ç”¨CORS\n\nå»ºè®®: è¾“å…¥GitHub Tokenåé‡è¯•`);
                };

                img2.src = asset.browser_download_url;
            };

            img.src = asset.browser_download_url;
        }



        // ä½¿ç”¨GitHub Assets APIä¸‹è½½ç§æœ‰ä»“åº“èµ„æº
        function loadAssetWithAPI(asset, token, requestId) {
            showLoading();

            // ä½¿ç”¨GitHub Assets API: GET /repos/{owner}/{repo}/releases/assets/{asset_id}
            const apiUrl = asset.url; // è¿™å°±æ˜¯æ­£ç¡®çš„assets API URL

            // å°è¯•æœ€ç®€åŒ–çš„è¯·æ±‚é…ç½®ï¼Œé¿å…CORSé¢„æ£€
            const requestOptions = {
                method: 'GET',
                headers: {
                    'Authorization': `bearer ${token}`,
                    'Accept': 'application/octet-stream'
                }
            };

            fetch(apiUrl, requestOptions)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('GitHub Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ');
                    } else if (response.status === 403) {
                        throw new Error('Tokenæƒé™ä¸è¶³ï¼Œéœ€è¦repoæƒé™');
                    } else if (response.status === 404) {
                        throw new Error('èµ„æºä¸å­˜åœ¨æˆ–æ— è®¿é—®æƒé™');
                    } else if (response.status === 405) {
                        throw new Error('æ–¹æ³•ä¸å…è®¸ - è¿™å¯èƒ½æ˜¯CORSé¢„æ£€è¯·æ±‚é—®é¢˜\n\nå»ºè®®:\n1. æ£€æŸ¥tokenæ ¼å¼æ˜¯å¦æ­£ç¡®\n2. ç¡®è®¤API URLæ˜¯å¦æ­£ç¡®\n3. å¯èƒ½éœ€è¦ä½¿ç”¨ä»£ç†æœåŠ¡å™¨');
                    }
                    throw new Error(`GitHub Assets APIé”™è¯¯: ${response.status} ${response.statusText}`);
                }

                // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†é‡å®šå‘ï¼Œç›´æ¥å¤„ç†blobå“åº”

                return response.blob();
            })
            .then(blob => {
                // æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                if (!isRequestValid(requestId)) {
                    console.log('è¯·æ±‚å·²è¿‡æœŸï¼Œå¿½ç•¥å“åº”:', requestId);
                    return;
                }

                // éªŒè¯blobæ˜¯å¦æœ‰æ•ˆ
                if (!blob || blob.size === 0) {
                    throw new Error('æ¥æ”¶åˆ°ç©ºçš„blobæ•°æ®');
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆHTTPS/HTTPï¼‰
                const isSecureContext = window.location.protocol !== 'file:';

                if (isSecureContext) {
                    // HTTPS/HTTPç¯å¢ƒï¼šä¼˜å…ˆä½¿ç”¨Blob URLï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
                    loadWithBlobUrl(blob, asset, requestId);
                } else {
                    // file://ç¯å¢ƒï¼šä½¿ç”¨Data URLï¼ˆç»•è¿‡åè®®é™åˆ¶ï¼‰
                    loadWithDataUrl(blob, asset, requestId);
                }
            })
            .catch(error => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯ä¸”åœ¨HTTPç¯å¢ƒä¸‹
                const isCorsError = error.message.includes('Failed to fetch') || error.message.includes('CORS');
                const isHttpContext = window.location.protocol === 'http:';

                if (isCorsError && isHttpContext) {
                    hideLoading();
                    showError(`HTTPç¯å¢ƒä¸‹GitHub Assets APIå—CORSé™åˆ¶\n\nå»ºè®®è§£å†³æ–¹æ¡ˆ:\n1. ğŸ”§ ä½¿ç”¨HTTPSæœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢\n2. ğŸ”§ ä½¿ç”¨file://åè®®ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶\n3. ğŸ”§ åœ¨æµè§ˆå™¨ä¸­ç¦ç”¨CORSæ£€æŸ¥\n\næ­£åœ¨å°è¯•å…¶ä»–åŠ è½½æ–¹å¼...`);

                    // è‡ªåŠ¨å°è¯•å…¶ä»–æ–¹æ³•
                    setTimeout(() => {
                        tryRedirectUrlWithContentType(asset);
                    }, 2000);
                } else {
                    showError(`GitHub Assets APIåŠ è½½å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥:\n1. GitHub Tokenæ˜¯å¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ\n2. Tokenæ˜¯å¦æœ‰repoæƒé™\n3. æ˜¯å¦æœ‰è®¿é—®è¯¥ä»“åº“çš„æƒé™\n4. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`);
                }
            });
        }

        // ä½¿ç”¨Blob URLåŠ è½½å›¾ç‰‡ï¼ˆHTTPSç¯å¢ƒæ¨èï¼‰
        function loadWithBlobUrl(blob, asset, requestId) {
            try {
                // ä¿®æ­£MIMEç±»å‹
                let correctedBlob = blob;
                if (blob.type === 'application/octet-stream') {
                    const extension = asset.name.toLowerCase().split('.').pop();
                    const mimeTypes = {
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'png': 'image/png',
                        'gif': 'image/gif',
                        'webp': 'image/webp',
                        'bmp': 'image/bmp',
                        'svg': 'image/svg+xml'
                    };

                    const correctMimeType = mimeTypes[extension];
                    if (correctMimeType) {
                        console.log('Correcting MIME type from', blob.type, 'to', correctMimeType);
                        correctedBlob = new Blob([blob], { type: correctMimeType });
                    }
                }

                // åˆ›å»ºBlob URL
                const blobUrl = URL.createObjectURL(correctedBlob);
                console.log('Blob URL created:', blobUrl);

                const img = new Image();

                // è®¾ç½®crossOriginä»¥å¤„ç†å¯èƒ½çš„è·¨åŸŸé—®é¢˜
                img.crossOrigin = 'anonymous';

                img.onload = function() {
                    // æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                    if (!isRequestValid(requestId)) {
                        console.log('è¯·æ±‚å·²è¿‡æœŸï¼Œå¿½ç•¥å›¾ç‰‡åŠ è½½:', requestId);
                        URL.revokeObjectURL(blobUrl);
                        return;
                    }

                    currentImage = {
                        url: blobUrl,
                        filename: asset.name,
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        size: formatFileSize(blob.size),
                        blobUrl: blobUrl,
                        isBlobUrl: true
                    };

                    // æ·»åŠ åˆ°ç¼“å­˜
                    addToCache(asset, currentImage);

                    displayImage(this);
                    hideLoading();
                    showSuccess(`å›¾ç‰‡åŠ è½½æˆåŠŸï¼\næ–‡ä»¶: ${asset.name}\nå¤§å°: ${formatFileSize(blob.size)}\n\nä½¿ç”¨Blob URLæ–¹å¼ï¼ˆé«˜æ€§èƒ½ï¼‰`);
                    enableControls();
                };

                img.onerror = function(event) {
                    // æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                    if (!isRequestValid(requestId)) {
                        console.log('è¯·æ±‚å·²è¿‡æœŸï¼Œå¿½ç•¥é”™è¯¯å¤„ç†:', requestId);
                        URL.revokeObjectURL(blobUrl);
                        return;
                    }

                    console.log('Blob URL failed, error:', event);
                    console.log('Falling back to Data URL...');
                    URL.revokeObjectURL(blobUrl);
                    loadWithDataUrl(blob, asset, requestId);
                };

                img.src = blobUrl;

            } catch (error) {
                console.error('Blob URL creation failed:', error);
                // å›é€€åˆ°Data URL
                loadWithDataUrl(blob, asset);
            }
        }

        // ä½¿ç”¨Data URLåŠ è½½å›¾ç‰‡ï¼ˆfile://ç¯å¢ƒæˆ–Blob URLå¤±è´¥æ—¶çš„å›é€€æ–¹æ¡ˆï¼‰
        function loadWithDataUrl(blob, asset, requestId) {

            const reader = new FileReader();

            reader.onload = function(event) {
                const dataUrl = event.target.result;
                console.log('Data URL created, length:', dataUrl.length);

                const img = new Image();
                img.onload = function() {
                    // æ£€æŸ¥è¯·æ±‚æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                    if (!isRequestValid(requestId)) {
                        console.log('è¯·æ±‚å·²è¿‡æœŸï¼Œå¿½ç•¥Data URLåŠ è½½:', requestId);
                        return;
                    }

                    currentImage = {
                        url: dataUrl,
                        filename: asset.name,
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        size: formatFileSize(blob.size),
                        isDataUrl: true
                    };

                    // æ·»åŠ åˆ°ç¼“å­˜
                    addToCache(asset, currentImage);

                    displayImage(this);
                    hideLoading();
                    showSuccess(`å›¾ç‰‡åŠ è½½æˆåŠŸï¼\næ–‡ä»¶: ${asset.name}\nå¤§å°: ${formatFileSize(blob.size)}\n\nä½¿ç”¨Data URLæ–¹å¼`);
                    enableControls();
                };

                img.onerror = function() {
                    hideLoading();
                    showError(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${asset.name}\n\nå¯èƒ½åŸå› :\n1. æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼\n2. æ–‡ä»¶å·²æŸå\n3. æµè§ˆå™¨ä¸æ”¯æŒè¯¥å›¾ç‰‡æ ¼å¼`);
                };

                img.src = dataUrl;
            };

            reader.onerror = function() {
                hideLoading();
                showError('æ— æ³•è¯»å–æ–‡ä»¶æ•°æ®');
            };

            reader.onprogress = function(event) {
                if (event.lengthComputable) {
                    const progress = (event.loaded / event.total * 100).toFixed(1);
                    console.log(`Data URL encoding progress: ${progress}%`);
                }
            };

            // è¯»å–ä¸ºData URL
            reader.readAsDataURL(blob);
        }

        // å¤„ç†å¤§æ–‡ä»¶çš„é€‰é¡¹
        function showLargeFileOptions(blob, asset) {
            hideLoading();

            // æ£€æŸ¥æ–‡ä»¶å¤´ç¡®è®¤æ˜¯å¦ä¸ºæœ‰æ•ˆå›¾ç‰‡
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                const header = Array.from(uint8Array.slice(0, 10)).map(b => b.toString(16).padStart(2, '0')).join(' ');

                // æ£€æŸ¥å¸¸è§å›¾ç‰‡æ ¼å¼çš„æ–‡ä»¶å¤´
                const isJPEG = uint8Array[0] === 0xFF && uint8Array[1] === 0xD8;
                const isPNG = uint8Array[0] === 0x89 && uint8Array[1] === 0x50 && uint8Array[2] === 0x4E && uint8Array[3] === 0x47;
                const isGIF = uint8Array[0] === 0x47 && uint8Array[1] === 0x49 && uint8Array[2] === 0x46;
                const isWebP = uint8Array[8] === 0x57 && uint8Array[9] === 0x45 && uint8Array[10] === 0x42 && uint8Array[11] === 0x50;

                let fileTypeInfo = 'æœªçŸ¥æ ¼å¼';
                if (isJPEG) fileTypeInfo = 'JPEGæ ¼å¼ âœ…';
                else if (isPNG) fileTypeInfo = 'PNGæ ¼å¼ âœ…';
                else if (isGIF) fileTypeInfo = 'GIFæ ¼å¼ âœ…';
                else if (isWebP) fileTypeInfo = 'WebPæ ¼å¼ âœ…';
                else fileTypeInfo = 'æœªçŸ¥æ ¼å¼ âš ï¸';

                // æ˜¾ç¤ºå¤§æ–‡ä»¶å¤„ç†ç•Œé¢
                const previewContent = document.getElementById('previewContent');


                previewContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“</div>
                        <h3 style="color: #667eea; margin-bottom: 20px;">æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•åœ¨æµè§ˆå™¨ä¸­é¢„è§ˆ</h3>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š æ–‡ä»¶ä¿¡æ¯</h4>
                            <div style="margin-bottom: 8px;"><strong>æ–‡ä»¶å:</strong> ${asset.name}</div>
                            <div style="margin-bottom: 8px;"><strong>å¤§å°:</strong> ${(blob.size / 1024 / 1024).toFixed(2)} MB</div>
                            <div style="margin-bottom: 8px;"><strong>æ ¼å¼:</strong> ${fileTypeInfo}</div>
                            <div style="margin-bottom: 8px;"><strong>æ–‡ä»¶å¤´:</strong> ${header}</div>
                        </div>

                        <div style="margin: 30px 0;">
                            <button onclick="tryDataUrlPreview('${asset.name}')"
                                    style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 16px;">
                                ğŸš€ Data URLé¢„è§ˆ
                            </button>
                            <button onclick="createThumbnailPreview('${asset.name}')"
                                    style="background: #17a2b8; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 16px;">
                                ğŸ–¼ï¸ ç”Ÿæˆç¼©ç•¥å›¾
                            </button>
                            <button onclick="downloadLargeFile('${asset.name}')"
                                    style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 16px;">
                                ğŸ“¥ ä¸‹è½½æ–‡ä»¶
                            </button>

                        </div>

                        <div style="color: #666; font-size: 14px; line-height: 1.5;">
                            <p><strong>å»ºè®®:</strong></p>
                            <p>â€¢ ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ä½¿ç”¨ä¸“ä¸šå›¾ç‰‡æŸ¥çœ‹å™¨</p>
                            <p>â€¢ æˆ–å‹ç¼©å›¾ç‰‡åˆ° &lt;10MB åé‡æ–°ä¸Šä¼ </p>
                            <p>â€¢ æµè§ˆå™¨é€šå¸¸æ— æ³•å¤„ç†è¶…è¿‡50MBçš„å›¾ç‰‡</p>
                        </div>
                    </div>
                `;

                // ä¿å­˜blobå¼•ç”¨ä¾›ä¸‹è½½ä½¿ç”¨
                window.currentLargeFileBlob = blob;

                enableControls();
                showSuccess(`æ–‡ä»¶ä¿¡æ¯è·å–æˆåŠŸï¼\næ ¼å¼: ${fileTypeInfo}\nå¤§å°: ${(blob.size / 1024 / 1024).toFixed(2)}MB`);
            };

            reader.readAsArrayBuffer(blob.slice(0, 20));
        }

        // ä¸‹è½½å¤§æ–‡ä»¶
        function downloadLargeFile(filename) {
            const blob = window.currentLargeFileBlob;
            if (!blob) {
                showError('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨ï¼Œè¯·é‡æ–°åŠ è½½');
                return;
            }

            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showSuccess('å¼€å§‹ä¸‹è½½æ–‡ä»¶...');
            } catch (error) {
                console.error('Download failed:', error);
                showError('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // åˆ†æå›¾ç‰‡æ–‡ä»¶å¹¶æä¾›è¯¦ç»†ä¿¡æ¯
        function analyzeImageFile(filename) {
            const blob = window.currentLargeFileBlob;
            if (!blob) {
                showError('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨ï¼Œè¯·é‡æ–°åŠ è½½');
                return;
            }

            showLoading();
            console.log('Starting image file analysis for:', filename);

            // åˆ†æå›¾ç‰‡æ–‡ä»¶
            analyzeImageStructure(blob, filename)
                .then(analysis => {
                    hideLoading();
                    displayImageAnalysis(analysis, filename);
                    enableControls();
                })
                .catch(error => {
                    console.error('Image analysis failed:', error);
                    hideLoading();
                    showError(`æ–‡ä»¶åˆ†æå¤±è´¥: ${error.message}\n\nå¯èƒ½åŸå› :\n1. æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ\n2. æ–‡ä»¶å·²æŸå\n3. è¯»å–æƒé™é—®é¢˜`);
                });
        }

        // åˆ†æå›¾ç‰‡æ–‡ä»¶ç»“æ„
        async function analyzeImageStructure(blob, filename) {
            console.log('Analyzing image structure...');

            const analysis = {
                filename: filename,
                size: blob.size,
                type: blob.type,
                isValid: false,
                format: 'Unknown',
                dimensions: null,
                metadata: {},
                issues: [],
                recommendations: []
            };

            try {
                // è¯»å–æ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
                const headerSize = Math.min(blob.size, 64 * 1024); // è¯»å–å‰64KB
                const headerBuffer = await blob.slice(0, headerSize).arrayBuffer();
                const headerBytes = new Uint8Array(headerBuffer);

                // åˆ†ææ–‡ä»¶æ ¼å¼
                analysis.format = detectImageFormat(headerBytes);
                analysis.isValid = analysis.format !== 'Unknown';

                if (analysis.format === 'JPEG') {
                    const jpegInfo = analyzeJPEGStructure(headerBytes);
                    analysis.dimensions = jpegInfo.dimensions;
                    analysis.metadata = jpegInfo.metadata;
                    analysis.issues = jpegInfo.issues;
                }

                // ç”Ÿæˆå»ºè®®
                generateRecommendations(analysis);

                return analysis;
            } catch (error) {
                analysis.issues.push(`åˆ†æè¿‡ç¨‹å‡ºé”™: ${error.message}`);
                return analysis;
            }
        }

        // æ£€æµ‹å›¾ç‰‡æ ¼å¼
        function detectImageFormat(bytes) {
            // JPEG: FF D8 FF
            if (bytes[0] === 0xFF && bytes[1] === 0xD8 && bytes[2] === 0xFF) {
                return 'JPEG';
            }
            // PNG: 89 50 4E 47
            if (bytes[0] === 0x89 && bytes[1] === 0x50 && bytes[2] === 0x4E && bytes[3] === 0x47) {
                return 'PNG';
            }
            // GIF: 47 49 46
            if (bytes[0] === 0x47 && bytes[1] === 0x49 && bytes[2] === 0x46) {
                return 'GIF';
            }
            // WebP: 52 49 46 46 ... 57 45 42 50
            if (bytes[0] === 0x52 && bytes[1] === 0x49 && bytes[2] === 0x46 && bytes[3] === 0x46 &&
                bytes[8] === 0x57 && bytes[9] === 0x45 && bytes[10] === 0x42 && bytes[11] === 0x50) {
                return 'WebP';
            }
            return 'Unknown';
        }

        // åˆ†æJPEGç»“æ„
        function analyzeJPEGStructure(bytes) {
            const info = {
                dimensions: null,
                metadata: {},
                issues: []
            };

            try {
                let offset = 2; // è·³è¿‡FF D8

                while (offset < bytes.length - 1) {
                    // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ ‡è®°
                    if (bytes[offset] !== 0xFF) {
                        offset++;
                        continue;
                    }

                    const marker = bytes[offset + 1];
                    offset += 2;

                    // SOF0 (Start of Frame) - åŒ…å«å›¾ç‰‡å°ºå¯¸ä¿¡æ¯
                    if (marker === 0xC0) {
                        if (offset + 6 < bytes.length) {
                            const height = (bytes[offset + 3] << 8) | bytes[offset + 4];
                            const width = (bytes[offset + 5] << 8) | bytes[offset + 6];
                            info.dimensions = { width, height };
                            info.metadata.colorComponents = bytes[offset + 7];
                        }
                        break;
                    }

                    // è·³è¿‡æ®µæ•°æ®
                    if (marker >= 0xE0 && marker <= 0xEF) {
                        // APPæ®µ
                        const segmentLength = (bytes[offset] << 8) | bytes[offset + 1];
                        offset += segmentLength;
                    } else if (marker === 0xDB) {
                        // é‡åŒ–è¡¨
                        const segmentLength = (bytes[offset] << 8) | bytes[offset + 1];
                        offset += segmentLength;
                    } else if (marker === 0xC4) {
                        // Huffmanè¡¨
                        const segmentLength = (bytes[offset] << 8) | bytes[offset + 1];
                        offset += segmentLength;
                    } else {
                        // å…¶ä»–æ®µ
                        if (offset + 1 < bytes.length) {
                            const segmentLength = (bytes[offset] << 8) | bytes[offset + 1];
                            offset += segmentLength;
                        } else {
                            break;
                        }
                    }
                }

                // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°äº†å°ºå¯¸ä¿¡æ¯
                if (!info.dimensions) {
                    info.issues.push('æ— æ³•æ‰¾åˆ°å›¾ç‰‡å°ºå¯¸ä¿¡æ¯');
                }

            } catch (error) {
                info.issues.push(`JPEGè§£æé”™è¯¯: ${error.message}`);
            }

            return info;
        }

        // ç”Ÿæˆå»ºè®®
        function generateRecommendations(analysis) {
            if (!analysis.isValid) {
                analysis.recommendations.push('æ–‡ä»¶æ ¼å¼æ— æ³•è¯†åˆ«ï¼Œå¯èƒ½å·²æŸå');
                return;
            }

            if (analysis.size > 100 * 1024 * 1024) {
                analysis.recommendations.push('æ–‡ä»¶è¿‡å¤§ï¼ˆ>100MBï¼‰ï¼Œå»ºè®®å‹ç¼©åå†é¢„è§ˆ');
            } else if (analysis.size > 50 * 1024 * 1024) {
                analysis.recommendations.push('æ–‡ä»¶è¾ƒå¤§ï¼ˆ>50MBï¼‰ï¼Œæµè§ˆå™¨å¯èƒ½æ— æ³•ç›´æ¥é¢„è§ˆ');
            }

            if (analysis.dimensions) {
                const { width, height } = analysis.dimensions;
                const megapixels = (width * height) / 1000000;

                if (megapixels > 100) {
                    analysis.recommendations.push(`å›¾ç‰‡åˆ†è¾¨ç‡å¾ˆé«˜ï¼ˆ${megapixels.toFixed(1)}MPï¼‰ï¼Œå»ºè®®é™ä½åˆ†è¾¨ç‡`);
                }

                analysis.recommendations.push('å¯ä»¥å°è¯•ä½¿ç”¨ä¸“ä¸šå›¾ç‰‡æŸ¥çœ‹è½¯ä»¶');
                analysis.recommendations.push('å»ºè®®ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹å®Œæ•´å›¾ç‰‡');
            }

            if (analysis.issues.length > 0) {
                analysis.recommendations.push('æ–‡ä»¶å¯èƒ½å­˜åœ¨ç»“æ„é—®é¢˜ï¼Œå»ºè®®é‡æ–°ç”Ÿæˆ');
            }
        }

        // æ˜¾ç¤ºå›¾ç‰‡åˆ†æç»“æœ
        function displayImageAnalysis(analysis, filename) {
            const previewContent = document.getElementById('previewContent');


            const statusIcon = analysis.isValid ? 'âœ…' : 'âŒ';
            const statusText = analysis.isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ';
            const statusColor = analysis.isValid ? '#28a745' : '#dc3545';

            previewContent.innerHTML = `
                <div style="padding: 30px; text-align: left;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 4em; margin-bottom: 15px;">ğŸ”</div>
                        <h2 style="color: #667eea;">å›¾ç‰‡æ–‡ä»¶åˆ†ææŠ¥å‘Š</h2>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 20px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <strong>æ–‡ä»¶å:</strong><br>
                                <span style="color: #666; word-break: break-all;">${analysis.filename}</span>
                            </div>
                            <div>
                                <strong>æ–‡ä»¶å¤§å°:</strong><br>
                                <span style="color: #666;">${formatFileSize(analysis.size)}</span>
                            </div>
                            <div>
                                <strong>MIMEç±»å‹:</strong><br>
                                <span style="color: #666;">${analysis.type || 'application/octet-stream'}</span>
                            </div>
                            <div>
                                <strong>æ£€æµ‹æ ¼å¼:</strong><br>
                                <span style="color: ${statusColor};">${statusIcon} ${analysis.format}</span>
                            </div>
                        </div>

                        ${analysis.dimensions ? `
                        <div style="margin-bottom: 20px;">
                            <strong>å›¾ç‰‡å°ºå¯¸:</strong><br>
                            <span style="color: #666; font-size: 1.2em;">${analysis.dimensions.width} Ã— ${analysis.dimensions.height} åƒç´ </span><br>
                            <span style="color: #888; font-size: 0.9em;">${((analysis.dimensions.width * analysis.dimensions.height) / 1000000).toFixed(1)} ç™¾ä¸‡åƒç´ </span>
                        </div>
                        ` : ''}

                        ${Object.keys(analysis.metadata).length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <strong>å…ƒæ•°æ®:</strong><br>
                            ${Object.entries(analysis.metadata).map(([key, value]) =>
                                `<span style="color: #666;">${key}: ${value}</span>`
                            ).join('<br>')}
                        </div>
                        ` : ''}
                    </div>

                    ${analysis.issues.length > 0 ? `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">âš ï¸ å‘ç°çš„é—®é¢˜</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${analysis.issues.map(issue => `<li style="margin-bottom: 8px;">${issue}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    ${analysis.recommendations.length > 0 ? `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">ğŸ’¡ å»ºè®®</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${analysis.recommendations.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <div style="background: #e7f3ff; border: 1px solid #b8daff; color: #004085; padding: 20px; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px;">ğŸ”§ æŠ€æœ¯åˆ†æ</h4>
                        <p style="margin-bottom: 10px;"><strong>ä¸ºä»€ä¹ˆæ— æ³•é¢„è§ˆï¼Ÿ</strong></p>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>æ–‡ä»¶å¤§å°ä¸º ${formatFileSize(analysis.size)}ï¼Œè¶…å‡ºäº†æµè§ˆå™¨çš„å†…å­˜é™åˆ¶</li>
                            <li>æµè§ˆå™¨çš„å›¾ç‰‡è§£ç å™¨æ— æ³•å¤„ç†æ­¤ç‰¹å®šçš„JPEGç¼–ç </li>
                            <li>å¯èƒ½ä½¿ç”¨äº†ç‰¹æ®Šçš„å‹ç¼©ç®—æ³•æˆ–è‰²å½©ç©ºé—´</li>
                            ${analysis.dimensions ? `<li>å›¾ç‰‡åˆ†è¾¨ç‡ä¸º ${analysis.dimensions.width}Ã—${analysis.dimensions.height}ï¼Œåƒç´ æ•°é‡å·¨å¤§</li>` : ''}
                        </ul>

                        <p style="margin: 15px 0 10px 0;"><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼Œä½¿ç”¨ä¸“ä¸šå›¾ç‰‡æŸ¥çœ‹è½¯ä»¶ï¼ˆå¦‚Photoshopã€GIMPï¼‰</li>
                            <li>ä½¿ç”¨å›¾ç‰‡å‹ç¼©å·¥å…·å‡å°æ–‡ä»¶å¤§å°</li>
                            <li>è½¬æ¢ä¸ºæ›´å…¼å®¹çš„æ ¼å¼</li>
                            <li>é™ä½å›¾ç‰‡åˆ†è¾¨ç‡</li>
                        </ul>
                    </div>
                </div>
            `;

            // ä¿å­˜åˆ†æç»“æœ
            currentImage = {
                url: null,
                filename: filename + ' (åˆ†ææŠ¥å‘Š)',
                analysis: analysis,
                isAnalysis: true
            };
        }





        // å°è¯•Data URLé¢„è§ˆå¤§æ–‡ä»¶
        function tryDataUrlPreview(filename) {
            const blob = window.currentLargeFileBlob;
            if (!blob) {
                showError('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨ï¼Œè¯·é‡æ–°åŠ è½½');
                return;
            }

            showLoading();
            console.log('Trying Data URL preview for large file:', filename, 'size:', blob.size);

            // ä½¿ç”¨FileReaderè½¬æ¢ä¸ºData URL
            const reader = new FileReader();

            reader.onload = function(event) {
                const dataUrl = event.target.result;
                console.log('Data URL created for large file, length:', dataUrl.length);

                const img = new Image();
                img.onload = function() {
                    currentImage = {
                        url: dataUrl,
                        filename: filename + ' (Data URL)',
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        size: formatFileSize(blob.size),
                        isDataUrl: true,
                        isLargeFile: true
                    };

                    displayImage(this);
                    hideLoading();
                    showSuccess(`å¤§æ–‡ä»¶Data URLé¢„è§ˆæˆåŠŸï¼\næ–‡ä»¶: ${filename}\nå¤§å°: ${formatFileSize(blob.size)}\n\nè¯æ˜äº†é—®é¢˜ç¡®å®ä¸åœ¨äºæ–‡ä»¶å¤§å°ï¼Œè€Œåœ¨äºåè®®é™åˆ¶ï¼`);
                    enableControls();
                };

                img.onerror = function() {
                    hideLoading();
                    showError(`Data URLé¢„è§ˆå¤±è´¥: ${filename}\n\nå¯èƒ½åŸå› :\n1. æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼\n2. æ–‡ä»¶å·²æŸå\n3. æµè§ˆå™¨ä¸æ”¯æŒè¯¥å›¾ç‰‡æ ¼å¼\n\nä½†è‡³å°‘è¯æ˜äº†Data URLå¯ä»¥å¤„ç†å¤§æ–‡ä»¶ï¼`);
                };

                img.src = dataUrl;
            };

            reader.onerror = function() {
                hideLoading();
                showError('æ— æ³•è¯»å–å¤§æ–‡ä»¶æ•°æ®');
            };

            reader.onprogress = function(event) {
                if (event.lengthComputable) {
                    const progress = (event.loaded / event.total * 100).toFixed(1);
                    console.log(`Reading progress: ${progress}%`);
                }
            };

            // è¯»å–ä¸ºData URL
            reader.readAsDataURL(blob);
        }

        // ç”Ÿæˆç¼©ç•¥å›¾é¢„è§ˆ
        function createThumbnailPreview(filename) {
            const blob = window.currentLargeFileBlob;
            if (!blob) {
                showError('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨ï¼Œè¯·é‡æ–°åŠ è½½');
                return;
            }

            showLoading();
            console.log('Creating thumbnail for large file...');

            // ä½¿ç”¨Canvasæ¥åˆ›å»ºç¼©ç•¥å›¾
            const img = new Image();

            // åˆ›å»ºä¸€ä¸ªè¾ƒå°çš„blobæ¥æµ‹è¯•
            const chunkSize = Math.min(blob.size, 10 * 1024 * 1024); // æœ€å¤šè¯»å–10MB
            const smallBlob = blob.slice(0, chunkSize);

            try {
                const url = URL.createObjectURL(smallBlob);

                img.onload = function() {
                    console.log('Original image loaded for thumbnail creation');

                    // åˆ›å»ºcanvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // è®¡ç®—ç¼©ç•¥å›¾å°ºå¯¸ï¼ˆæœ€å¤§800pxï¼‰
                    const maxSize = 800;
                    let { width, height } = this;

                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // ç»˜åˆ¶ç¼©ç•¥å›¾
                    ctx.drawImage(this, 0, 0, width, height);

                    // è½¬æ¢ä¸ºblob
                    canvas.toBlob(function(thumbnailBlob) {
                        URL.revokeObjectURL(url);

                        if (thumbnailBlob) {
                            console.log('Thumbnail created:', {
                                originalSize: blob.size,
                                thumbnailSize: thumbnailBlob.size,
                                dimensions: `${width}x${height}`
                            });

                            const thumbnailUrl = URL.createObjectURL(thumbnailBlob);

                            currentImage = {
                                url: thumbnailUrl,
                                filename: filename + ' (ç¼©ç•¥å›¾)',
                                width: width,
                                height: height,
                                size: formatFileSize(thumbnailBlob.size),
                                blobUrl: thumbnailUrl,
                                isThumbnail: true,
                                originalSize: formatFileSize(blob.size)
                            };

                            displayThumbnailImage(currentImage);
                            hideLoading();
                            showSuccess(`ç¼©ç•¥å›¾ç”ŸæˆæˆåŠŸï¼\nåŸå§‹å¤§å°: ${formatFileSize(blob.size)}\nç¼©ç•¥å›¾å¤§å°: ${formatFileSize(thumbnailBlob.size)}`);
                            enableControls();
                        } else {
                            hideLoading();
                            showError('ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥');
                        }
                    }, 'image/jpeg', 0.8); // 80%è´¨é‡çš„JPEG
                };

                img.onerror = function() {
                    URL.revokeObjectURL(url);
                    hideLoading();
                    showError('æ— æ³•åŠ è½½å›¾ç‰‡è¿›è¡Œç¼©ç•¥å›¾ç”Ÿæˆ\n\nå¯èƒ½åŸå› :\n1. æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ\n2. æ–‡ä»¶å·²æŸå\n3. æµè§ˆå™¨å†…å­˜ä¸è¶³');
                };

                img.src = url;

            } catch (error) {
                hideLoading();
                showError('ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºç¼©ç•¥å›¾
        function displayThumbnailImage(imageInfo) {
            const previewContent = document.getElementById('previewContent');
            const previewTitle = document.getElementById('previewTitle');

            previewContent.innerHTML = `
                <div class="image-container">
                    <img src="${imageInfo.url}" alt="ç¼©ç•¥å›¾é¢„è§ˆ" class="preview-image" id="previewImg" data-original="${imageInfo.url}">
                </div>
            `;



            // åˆå§‹åŒ–Viewer.js
            initViewer();
        }

        // å¼ºåˆ¶é¢„è§ˆå¤§æ–‡ä»¶ï¼ˆè­¦å‘Šç”¨æˆ·å¯èƒ½å¡æ­»ï¼‰
        function tryForcePreview(filename) {
            const blob = window.currentLargeFileBlob;
            if (!blob) {
                showError('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨ï¼Œè¯·é‡æ–°åŠ è½½');
                return;
            }
            if (!confirm('è­¦å‘Šï¼šå¼ºåˆ¶é¢„è§ˆå¤§æ–‡ä»¶å¯èƒ½å¯¼è‡´æµè§ˆå™¨å¡æ­»æˆ–å´©æºƒï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            showLoading();

            // å»¶è¿Ÿæ‰§è¡Œï¼Œè®©ç”¨æˆ·çœ‹åˆ°è­¦å‘Š
            setTimeout(() => {
                try {
                    const correctedBlob = new Blob([blob], { type: 'image/jpeg' });
                    const imageUrl = URL.createObjectURL(correctedBlob);

                    if (!imageUrl || imageUrl.includes('blob:null')) {
                        throw new Error('æ— æ³•åˆ›å»ºblob URL');
                    }

                    const img = new Image();
                    const loadTimeout = setTimeout(() => {
                        URL.revokeObjectURL(imageUrl);
                        showError('é¢„è§ˆè¶…æ—¶ï¼Œæ–‡ä»¶è¿‡å¤§æ— æ³•å¤„ç†');
                    }, 60000); // 60ç§’è¶…æ—¶

                    img.onload = function() {
                        clearTimeout(loadTimeout);
                        currentImage = {
                            url: imageUrl,
                            filename: filename,
                            width: this.naturalWidth,
                            height: this.naturalHeight,
                            size: formatFileSize(blob.size),
                            blobUrl: imageUrl
                        };

                        displayImage(this);
                        hideLoading();
                        showSuccess('å¤§æ–‡ä»¶é¢„è§ˆæˆåŠŸï¼');
                        enableControls();
                    };

                    img.onerror = function() {
                        clearTimeout(loadTimeout);
                        URL.revokeObjectURL(imageUrl);
                        showError('å¼ºåˆ¶é¢„è§ˆå¤±è´¥ï¼Œæ–‡ä»¶æ— æ³•ä½œä¸ºå›¾ç‰‡æ˜¾ç¤º');
                    };

                    img.src = imageUrl;
                } catch (error) {
                    showError('å¼ºåˆ¶é¢„è§ˆå¤±è´¥: ' + error.message);
                }
            }, 1000);
        }

        // ä½¿ç”¨Data URLä½œä¸ºblob URLçš„å›é€€æ–¹æ¡ˆ
        function createDataURL(blob, asset) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function(event) {
                    const dataUrl = event.target.result;
                    console.log('Created Data URL, length:', dataUrl.length);

                    const img = new Image();
                    img.onload = function() {
                        console.log('Image loaded via Data URL:', {
                            width: this.naturalWidth,
                            height: this.naturalHeight
                        });

                        currentImage = {
                            url: dataUrl,
                            filename: asset.name,
                            width: this.naturalWidth,
                            height: this.naturalHeight,
                            size: formatFileSize(blob.size),
                            isDataUrl: true
                        };

                        displayImage(this);
                        hideLoading();
                        showSuccess('ç§æœ‰ä»“åº“èµ„æºåŠ è½½æˆåŠŸï¼(ä½¿ç”¨Data URL)');
                        enableControls();
                        resolve();
                    };

                    img.onerror = function(event) {
                        console.error('Data URL image load error:', event);
                        reject(new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${asset.name}\n\nå³ä½¿ä½¿ç”¨Data URLä¹Ÿæ— æ³•åŠ è½½ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåæˆ–ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼`));
                    };

                    img.src = dataUrl;
                };

                reader.onerror = function(event) {
                    console.error('FileReader error:', event);
                    reject(new Error('æ— æ³•è¯»å–blobæ•°æ®'));
                };

                // è¯»å–ä¸ºData URL
                reader.readAsDataURL(blob);
            });
        }

        // å¸¦å›é€€æœºåˆ¶çš„å›¾ç‰‡åŠ è½½
        function loadImageWithFallback(url, filename, useToken = false) {
            showLoading();

            if (useToken) {
                // å¯¹äºç§æœ‰ä»“åº“ï¼Œä½¿ç”¨fetch + tokençš„æ–¹å¼
                loadPrivateImage(url, filename);
            } else {
                // å…¬å¼€ä»“åº“çš„ç›´æ¥åŠ è½½æ–¹å¼
                loadPublicImage(url, filename);
            }
        }

        // åŠ è½½å…¬å¼€å›¾ç‰‡
        function loadPublicImage(url, filename) {
            // é¦–å…ˆå°è¯•ç›´æ¥åŠ è½½
            const img = new Image();
            img.crossOrigin = 'anonymous';

            img.onload = function() {
                currentImage = {
                    url: url,
                    filename: filename,
                    width: this.naturalWidth,
                    height: this.naturalHeight,
                    size: 'Unknown'
                };

                displayImage(this);
                hideLoading();
                showSuccess('å›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                enableControls();
            };

            img.onerror = function() {
                console.log('CORS load failed, trying without CORS...');

                const img2 = new Image();
                img2.onload = function() {
                    currentImage = {
                        url: url,
                        filename: filename,
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        size: 'Unknown'
                    };

                    displayImage(this);
                    hideLoading();
                    showSuccess('å›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                    enableControls();
                };

                img2.onerror = function() {
                    console.log('Direct load also failed, checking if token is available...');

                    // å¦‚æœç›´æ¥åŠ è½½å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰tokenå¯ç”¨
                    const token = document.getElementById('githubToken').value.trim();
                    if (token && url.includes('github.com')) {
                        console.log('Token available, trying authenticated load...');
                        loadPrivateImage(url, filename);
                    } else {
                        console.error('All loading attempts failed for:', url);
                        showError(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${filename}\n\nå¯èƒ½åŸå› :\n1. è¿™æ˜¯ç§æœ‰ä»“åº“ï¼Œéœ€è¦GitHub Token\n2. ç½‘ç»œè¿æ¥é—®é¢˜\n3. æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²åˆ é™¤\n\nå»ºè®®:\n1. å¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼Œè¯·æä¾›GitHub Token\n2. æ£€æŸ¥æ–‡ä»¶URLæ˜¯å¦æ­£ç¡®\n3. å°è¯•åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®URL`);
                    }
                };

                img2.src = url;
            };

            img.src = url;
        }

        // åŠ è½½ç§æœ‰ä»“åº“å›¾ç‰‡
        function loadPrivateImage(url, filename) {
            const token = document.getElementById('githubToken').value.trim();

            if (!token) {
                showError('ç§æœ‰ä»“åº“éœ€è¦GitHub Tokenæ‰èƒ½è®¿é—®å›¾ç‰‡èµ„æº');
                return;
            }

            console.log('Loading private image with token:', url);

            // ä½¿ç”¨fetchè·å–å›¾ç‰‡æ•°æ®ï¼ŒåŒ…å«è®¤è¯ä¿¡æ¯
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `bearer ${token}`,
                    'Accept': 'application/octet-stream',
                    'User-Agent': 'Shot-Stitch-Preview/1.0'
                },
                mode: 'cors',
                credentials: 'omit'
            })
            .then(response => {
                console.log('Fetch response:', response);
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('GitHub Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ');
                    } else if (response.status === 403) {
                        throw new Error('Tokenæƒé™ä¸è¶³ï¼Œéœ€è¦repoæƒé™');
                    } else if (response.status === 404) {
                        throw new Error('æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— è®¿é—®æƒé™');
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
            .then(blob => {
                console.log('Image blob received:', blob);

                // æ£€æŸ¥blobç±»å‹
                if (!blob.type.startsWith('image/')) {
                    console.warn('Blob type is not image:', blob.type);
                }

                // åˆ›å»ºæœ¬åœ°URL
                const imageUrl = URL.createObjectURL(blob);

                const img = new Image();
                img.onload = function() {
                    currentImage = {
                        url: imageUrl,
                        filename: filename,
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        size: formatFileSize(blob.size),
                        blobUrl: imageUrl // ä¿å­˜blob URLç”¨äºæ¸…ç†
                    };

                    displayImage(this);
                    hideLoading();
                    showSuccess('ç§æœ‰ä»“åº“å›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                    enableControls();
                };

                img.onerror = function() {
                    console.error('Image load error after blob creation');
                    URL.revokeObjectURL(imageUrl);
                    showError(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${filename}\n\nå¯èƒ½åŸå› :\n1. æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼\n2. æ–‡ä»¶å·²æŸå\n3. æµè§ˆå™¨ä¸æ”¯æŒè¯¥å›¾ç‰‡æ ¼å¼`);
                };

                img.src = imageUrl;
            })
            .catch(error => {
                console.error('Private image load failed:', error);
                showError(`ç§æœ‰ä»“åº“å›¾ç‰‡åŠ è½½å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥:\n1. GitHub Tokenæ˜¯å¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ\n2. Tokenæ˜¯å¦æœ‰repoæƒé™\n3. æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºè¯¥å‘å¸ƒç‰ˆæœ¬ä¸­\n4. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`);
            });
        }

        function hideAssetSelect() {
            const assetSelectGroup = document.getElementById('assetSelectGroup');
            const defaultHeader = document.getElementById('defaultHeader');
            const previewContent = document.getElementById('previewContent');

            // éšè—é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºé»˜è®¤æ ‡é¢˜
            assetSelectGroup.style.display = 'none';
            defaultHeader.style.display = 'block';

            // æ¸…ç©ºé¢„è§ˆåŒºåŸŸ
            previewContent.innerHTML = `
                <div class="preview-placeholder">
                    <div class="icon">ğŸ–¼ï¸</div>
                    <div>é€‰æ‹©å›¾ç‰‡URLæˆ–GitHubä»“åº“å¼€å§‹é¢„è§ˆ</div>
                    <div style="font-size: 0.9em; opacity: 0.7;">æ”¯æŒ JPG, PNG, WebP, GIF ç­‰æ ¼å¼</div>
                </div>
            `;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°å’Œç¯å¢ƒæ”¯æŒ
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const imageUrl = urlParams.get('url');

            if (imageUrl) {
                document.getElementById('imageUrl').value = imageUrl;
                loadImageFromUrl();
            }


        });


    </script>
</body>
</html>
