name: ç”Ÿæˆè§†é¢‘æˆªå›¾

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'è§†é¢‘ URL'
        required: true
        type: string
      preset:
        description: 'é¢„è®¾æ¨¡å¼'
        required: false
        default: 'dynamic'
        type: choice
        options:
        - movie
        - lecture
        - quick
        - dynamic
      target_repo:
        description: 'å‘å¸ƒåˆ°çš„ä»“åº“'
        required: false
        default: 'kkfive/shot-stitch'
        type: string
      

permissions:
  contents: read

jobs:
  generate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: éªŒè¯è¾“å…¥
      run: |
        if [[ ! "$VIDEO_URL" =~ ^https?:// ]]; then
          echo "âŒ æ— æ•ˆçš„ URL æ ¼å¼"
          exit 1
        fi
        echo "âœ… URL éªŒè¯é€šè¿‡"
      env:
        VIDEO_URL: ${{ inputs.video_url }}
    
    - name: è®¾ç½® Hosts æ˜ å°„
      run: |
        if [ -n "$HOSTS_MAPPING" ]; then
          echo "ğŸ”§ è®¾ç½® hosts æ˜ å°„..."
          echo "$HOSTS_MAPPING" | sudo tee -a /etc/hosts > /dev/null
          echo "âœ… Hosts æ˜ å°„è®¾ç½®å®Œæˆ"
        else
          echo "â„¹ï¸ æœªè®¾ç½® hosts æ˜ å°„ï¼Œè·³è¿‡"
        fi
      env:
        HOSTS_MAPPING: ${{ secrets.HOSTS_MAPPING }}
    
    - name: ä¸‹è½½è§†é¢‘
      run: |
        mkdir -p video_input

        echo "â¬‡ï¸ æ­£åœ¨è·å–è§†é¢‘èµ„æº..."
        echo "ğŸ”— URL: $VIDEO_URL"

        # ä» URL ä¸­æå–åŸå§‹æ–‡ä»¶å
        ORIGINAL_FILENAME=$(echo "$VIDEO_URL" | sed 's/.*\///' | sed 's/\?.*$//')
        if [ -z "$ORIGINAL_FILENAME" ] || [[ ! "$ORIGINAL_FILENAME" =~ \. ]]; then
          ORIGINAL_FILENAME="video.mp4"
        fi

        echo "ğŸ“ åŸå§‹æ–‡ä»¶å: $ORIGINAL_FILENAME"
        echo "ORIGINAL_FILENAME=$ORIGINAL_FILENAME" >> $GITHUB_ENV

        # é¦–å…ˆè·å–æ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“Š è·å–æ–‡ä»¶ä¿¡æ¯..."
        CONTENT_LENGTH=$(curl -sI -L "$VIDEO_URL" | grep -i content-length | tail -1 | cut -d' ' -f2 | tr -d '\r')
        if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
          CONTENT_LENGTH_MB=$((CONTENT_LENGTH / 1024 / 1024))
          echo "ğŸ“ æ–‡ä»¶å¤§å°: ${CONTENT_LENGTH_MB}MB"
        else
          echo "âš ï¸ æ— æ³•è·å–æ–‡ä»¶å¤§å°ä¿¡æ¯"
        fi

        # ä½¿ç”¨ curl ä¸‹è½½ï¼Œä¿æŒåŸå§‹æ–‡ä»¶å
        echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½..."
        if curl -L --fail --progress-bar \
               --connect-timeout 30 --max-time 3600 \
               --user-agent "Mozilla/5.0 (compatible; VideoProcessor/1.0)" \
               --output "video_input/$ORIGINAL_FILENAME" \
               --write-out "âœ… ä¸‹è½½å®Œæˆ - å®é™…å¤§å°: %{size_download} å­—èŠ‚ - æ€»ç”¨æ—¶: %{time_total}s - å¹³å‡é€Ÿåº¦: %{speed_download} B/s\n" \
               "$VIDEO_URL"; then

          # éªŒè¯æ–‡ä»¶å¹¶æ˜¾ç¤ºå‹å¥½çš„å¤§å°
          if [ -f "video_input/$ORIGINAL_FILENAME" ] && [ -s "video_input/$ORIGINAL_FILENAME" ]; then
            FILE_SIZE=$(du -h "video_input/$ORIGINAL_FILENAME" | cut -f1)
            FILE_SIZE_BYTES=$(stat -c%s "video_input/$ORIGINAL_FILENAME" 2>/dev/null || stat -f%z "video_input/$ORIGINAL_FILENAME" 2>/dev/null)
            echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶å¤§å°: ${FILE_SIZE} (${FILE_SIZE_BYTES} å­—èŠ‚)"

            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆå¦‚æœæœ‰é¢„æœŸå¤§å°ï¼‰
            if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
              if [ "$FILE_SIZE_BYTES" -eq "$CONTENT_LENGTH" ]; then
                echo "âœ… æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡"
              else
                echo "âš ï¸ æ–‡ä»¶å¤§å°ä¸åŒ¹é… (é¢„æœŸ: $CONTENT_LENGTH, å®é™…: $FILE_SIZE_BYTES)"
              fi
            fi
          else
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆæˆ–ä¸ºç©º"
            exit 1
          fi
        else
          echo "âŒ è§†é¢‘ä¸‹è½½å¤±è´¥"
          exit 1
        fi
      env:
        VIDEO_URL: ${{ inputs.video_url }}
    
    - name: ç”Ÿæˆæˆªå›¾
      run: |
        echo "ğŸ¬ å¼€å§‹ç”Ÿæˆæˆªå›¾..."

        # ä»åŸå§‹æ–‡ä»¶åä¸­æå–åŸºç¡€åç§°ï¼ˆä¸å«æ‰©å±•åï¼‰
        VIDEO_FILENAME=$(echo "$ORIGINAL_FILENAME" | sed 's/\.[^.]*$//')
        VIDEO_FILENAME=$(echo "$VIDEO_FILENAME" | sed 's/[^a-zA-Z0-9_-]/_/g' | sed 's/__*/_/g' | sed 's/^_\|_$//g')

        echo "ğŸ“ è§†é¢‘æ–‡ä»¶å: $VIDEO_FILENAME"
        echo "VIDEO_FILENAME=$VIDEO_FILENAME" >> $GITHUB_ENV

        # è¿è¡Œ shot-stitch Docker å®¹å™¨ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶å
        docker run --rm \
          -v $(pwd)/video_input:/data \
          dreamytzk/shot-stitch:latest \
          "/data/$ORIGINAL_FILENAME" \
          --preset ${{ inputs.preset }} \
          --html \
          --force

        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        SCREENSHOT_COUNT=$(find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$ORIGINAL_FILENAME" | wc -l)

        if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•æˆªå›¾æ–‡ä»¶"
          exit 1
        fi

        echo "âœ… æˆªå›¾ç”Ÿæˆå®Œæˆï¼Œå…±ç”Ÿæˆ $SCREENSHOT_COUNT ä¸ªæ–‡ä»¶"

        # åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        echo "ğŸ“Š ç”Ÿæˆçš„æ–‡ä»¶:"
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$ORIGINAL_FILENAME" | while read file; do
          echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
        done
    
    - name: å‡†å¤‡ Release ä¿¡æ¯
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        RELEASE_TAG="screenshots-${TIMESTAMP}"
        RELEASE_NAME="$VIDEO_FILENAME æˆªå›¾ - $(date '+%Y-%m-%d %H:%M:%S')"
        TARGET_REPO="${{ inputs.target_repo }}"

        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
        echo "TARGET_REPO=$TARGET_REPO" >> $GITHUB_ENV
        
        # åˆ›å»º Release æè¿°
        echo "# è§†é¢‘æˆªå›¾æ–‡ä»¶" > release_notes.md
        echo "" >> release_notes.md
        echo "**è§†é¢‘æ–‡ä»¶å**: \`$VIDEO_FILENAME\`" >> release_notes.md
        echo "**é¢„è®¾æ¨¡å¼**: \`${{ inputs.preset }}\`" >> release_notes.md
        echo "**ç›®æ ‡ä»“åº“**: \`$TARGET_REPO\`" >> release_notes.md
        echo "**ç”Ÿæˆæ—¶é—´**: \`$(date '+%Y-%m-%d %H:%M:%S')\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## åŒ…å«æ–‡ä»¶" >> release_notes.md
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$ORIGINAL_FILENAME" | while read file; do
          original_filename=$(basename "$file")

          # ä¿æŒåŸå§‹æ–‡ä»¶åï¼Œä¸è¿›è¡Œé‡å‘½å
          echo "- \`$original_filename\` ($(du -h "$file" | cut -f1))" >> release_notes.md
        done
        echo "- \`${VIDEO_FILENAME}_all_files.zip\` (åŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…)" >> release_notes.md
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> release_notes.md
        
        echo "âœ… Release ä¿¡æ¯å‡†å¤‡å®Œæˆ"
    
    - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      run: |
        echo "ğŸš€ åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶..."

        # åˆ›å»º Release
        gh release create "$RELEASE_TAG" \
          --repo "$TARGET_REPO" \
          --title "$RELEASE_NAME" \
          --notes-file release_notes.md

        echo "âœ… Release åˆ›å»ºæˆåŠŸ: $RELEASE_TAG"

        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºé‡å‘½åæ–‡ä»¶
        mkdir -p temp_upload

        # ä¸Šä¼ æ‰€æœ‰æˆªå›¾æ–‡ä»¶ï¼ˆä¿æŒåŸå§‹æ–‡ä»¶åï¼‰
        echo "ğŸ“¤ ä¸Šä¼ æˆªå›¾æ–‡ä»¶..."
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$ORIGINAL_FILENAME" | while read file; do
          original_filename=$(basename "$file")

          # å¤åˆ¶æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•ï¼Œä¿æŒåŸå§‹æ–‡ä»¶å
          cp "$file" "temp_upload/$original_filename"
          echo "ğŸ“¤ ä¸Šä¼ : $original_filename"

          gh release upload "$RELEASE_TAG" "temp_upload/$original_filename" \
            --repo "$TARGET_REPO" \
            --clobber
        done

        # åˆ›å»ºåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…
        echo "ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…..."
        cd temp_upload
        zip_filename="${VIDEO_FILENAME}_all_files.zip"
        zip -r "$zip_filename" .
        echo "ğŸ“¤ ä¸Šä¼ å‹ç¼©åŒ…: $zip_filename"

        gh release upload "$RELEASE_TAG" "$zip_filename" \
          --repo "$TARGET_REPO" \
          --clobber
        cd ..

        echo "âœ… æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
        echo "RELEASE_URL=https://github.com/$TARGET_REPO/releases/tag/$RELEASE_TAG" >> $GITHUB_ENV
      env:
        GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
    
    - name: ç”Ÿæˆä¸‹è½½ä¿¡æ¯
      run: |
        echo "ğŸ‰ æˆªå›¾å·²æˆåŠŸä¸Šä¼ åˆ°ç›®æ ‡ä»“åº“!"
        echo ""
        echo "ğŸ“ ç›®æ ‡ä»“åº“: $TARGET_REPO"
        echo "ğŸ·ï¸  Release æ ‡ç­¾: $RELEASE_TAG"
        echo "ğŸ”— Release é“¾æ¥: $RELEASE_URL"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
        echo "1. è®¿é—®ç›®æ ‡ä»“åº“çš„ Releases é¡µé¢"
        echo "2. æ‰¾åˆ°æ ‡ç­¾ä¸º '$RELEASE_TAG' çš„ Release"
        echo "3. ç›´æ¥ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼ˆæ— éœ€è§£å‹ï¼‰"
        echo ""
        echo "ğŸ“Š å¯ä¸‹è½½çš„æ–‡ä»¶:"
        find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$ORIGINAL_FILENAME" | while read file; do
          original_filename=$(basename "$file")
          echo "  - $original_filename ($(du -h "$file" | cut -f1))"
        done
        echo "  - ${VIDEO_FILENAME}_all_files.zip (åŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…)"
        echo ""
        echo "ğŸ”’ åªæœ‰ç›®æ ‡ä»“åº“çš„åä½œè€…å¯ä»¥è®¿é—®å’Œä¸‹è½½"
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf video_input/ release_notes.md temp_upload/
        echo "âœ… æ¸…ç†å®Œæˆ"
