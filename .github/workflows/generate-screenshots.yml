name: ç”Ÿæˆè§†é¢‘æˆªå›¾

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'è§†é¢‘ URL'
        required: true
        type: string
      preset:
        description: 'é¢„è®¾æ¨¡å¼'
        required: false
        default: 'dynamic'
        type: choice
        options:
        - movie
        - lecture
        - quick
        - dynamic
      target_repo:
        description: 'å‘å¸ƒåˆ°çš„ä»“åº“'
        required: false
        default: 'kkfive/shot-stitch'
        type: string
      custom_filename:
        description: 'è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¯é€‰ï¼Œä¸å«æ‰©å±•åï¼Œç”¨äºé‡å‘½åä¸‹è½½çš„è§†é¢‘æ–‡ä»¶ï¼‰'
        required: false
        type: string


permissions:
  contents: read

jobs:
  generate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: éªŒè¯è¾“å…¥
      run: |
        if [[ ! "$VIDEO_URL" =~ ^https?:// ]]; then
          echo "âŒ æ— æ•ˆçš„ URL æ ¼å¼"
          exit 1
        fi
        echo "âœ… URL éªŒè¯é€šè¿‡"

        # éªŒè¯è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¦‚æœæä¾›ï¼‰
        if [ -n "$CUSTOM_FILENAME" ]; then
          # æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸å®‰å…¨çš„å­—ç¬¦
          if [[ "$CUSTOM_FILENAME" =~ [\<\>\:\"\|\?\*\/\\] ]]; then
            echo "âŒ è‡ªå®šä¹‰æ–‡ä»¶ååŒ…å«ä¸å®‰å…¨çš„å­—ç¬¦: $CUSTOM_FILENAME"
            echo "è¯·é¿å…ä½¿ç”¨ä»¥ä¸‹å­—ç¬¦: < > : \" | ? * / \\"
            exit 1
          fi
          # æ£€æŸ¥é•¿åº¦
          if [ ${#CUSTOM_FILENAME} -gt 100 ]; then
            echo "âŒ è‡ªå®šä¹‰æ–‡ä»¶åè¿‡é•¿ï¼ˆè¶…è¿‡100å­—ç¬¦ï¼‰: $CUSTOM_FILENAME"
            exit 1
          fi
          echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶åéªŒè¯é€šè¿‡: $CUSTOM_FILENAME"
        fi
      env:
        VIDEO_URL: ${{ inputs.video_url }}
        CUSTOM_FILENAME: ${{ inputs.custom_filename }}
    
    - name: è®¾ç½® Hosts æ˜ å°„
      run: |
        if [ -n "$HOSTS_MAPPING" ]; then
          echo "ğŸ”§ è®¾ç½® hosts æ˜ å°„..."
          echo "$HOSTS_MAPPING" | sudo tee -a /etc/hosts > /dev/null
          echo "âœ… Hosts æ˜ å°„è®¾ç½®å®Œæˆ"
        else
          echo "â„¹ï¸ æœªè®¾ç½® hosts æ˜ å°„ï¼Œè·³è¿‡"
        fi
      env:
        HOSTS_MAPPING: ${{ secrets.HOSTS_MAPPING }}
    
    - name: ä¸‹è½½è§†é¢‘
      run: |
        mkdir -p video_input

        echo "â¬‡ï¸ æ­£åœ¨è·å–è§†é¢‘èµ„æº..."
        echo "ğŸ”— URL: $VIDEO_URL"

        # ä» URL ä¸­æå–åŸå§‹æ–‡ä»¶å
        URL_FILENAME=$(echo "$VIDEO_URL" | sed 's/.*\///' | sed 's/\?.*$//')
        if [ -z "$URL_FILENAME" ] || [[ ! "$URL_FILENAME" =~ \. ]]; then
          URL_FILENAME="video.mp4"
        fi

        echo "ğŸ“ URLä¸­çš„æ–‡ä»¶å: $URL_FILENAME"

        # æå–æ‰©å±•åï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
        if [[ "$URL_FILENAME" =~ \. ]]; then
          EXTENSION="${URL_FILENAME##*.}"
        else
          EXTENSION="mp4"
        fi

        # ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„æ–‡ä»¶å
        if [ -n "${{ inputs.custom_filename }}" ]; then
          # 1. ç”¨æˆ·ä¼ å…¥é‡å‘½åå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¼ å…¥çš„åç§°
          FINAL_FILENAME="${{ inputs.custom_filename }}.${EXTENSION}"
          echo "ğŸ“ ä½¿ç”¨è‡ªå®šä¹‰æ–‡ä»¶å: $FINAL_FILENAME"
        else
          # 2. ç”¨æˆ·æœªä¼ å…¥é‡å‘½åå‚æ•°ï¼Œæ£€æµ‹æ˜¯å¦éœ€è¦è§£ç 
          if [[ "$URL_FILENAME" =~ %[0-9A-Fa-f]{2} ]]; then
            # æ£€æµ‹åˆ°URLç¼–ç ï¼Œè¿›è¡Œè§£ç 
            DECODED_FILENAME=$(printf '%b' "${URL_FILENAME//%/\\x}")
            FINAL_FILENAME="$DECODED_FILENAME"
            echo "ğŸ“ æ£€æµ‹åˆ°URLç¼–ç ï¼Œè§£ç å: $FINAL_FILENAME"
          else
            # æ— éœ€è§£ç 
            FINAL_FILENAME="$URL_FILENAME"
            echo "ğŸ“ ä½¿ç”¨åŸå§‹æ–‡ä»¶å: $FINAL_FILENAME"
          fi
        fi

        echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV
        echo "URL_FILENAME=$URL_FILENAME" >> $GITHUB_ENV

        # é¦–å…ˆè·å–æ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“Š è·å–æ–‡ä»¶ä¿¡æ¯..."
        CONTENT_LENGTH=$(curl -sI -L "$VIDEO_URL" | grep -i content-length | tail -1 | cut -d' ' -f2 | tr -d '\r')
        if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
          CONTENT_LENGTH_MB=$((CONTENT_LENGTH / 1024 / 1024))
          echo "ğŸ“ æ–‡ä»¶å¤§å°: ${CONTENT_LENGTH_MB}MB"
        else
          echo "âš ï¸ æ— æ³•è·å–æ–‡ä»¶å¤§å°ä¿¡æ¯"
        fi

        # ä½¿ç”¨ curl ä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶å
        TEMP_FILENAME="temp_download_$(date +%s).tmp"
        echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½..."
        if curl -L --fail --progress-bar \
               --connect-timeout 30 --max-time 3600 \
               --user-agent "Mozilla/5.0 (compatible; VideoProcessor/1.0)" \
               --output "video_input/$TEMP_FILENAME" \
               --write-out "âœ… ä¸‹è½½å®Œæˆ - å®é™…å¤§å°: %{size_download} å­—èŠ‚ - æ€»ç”¨æ—¶: %{time_total}s - å¹³å‡é€Ÿåº¦: %{speed_download} B/s\n" \
               "$VIDEO_URL"; then

          # éªŒè¯æ–‡ä»¶å¹¶æ˜¾ç¤ºå‹å¥½çš„å¤§å°
          if [ -f "video_input/$TEMP_FILENAME" ] && [ -s "video_input/$TEMP_FILENAME" ]; then
            FILE_SIZE=$(du -h "video_input/$TEMP_FILENAME" | cut -f1)
            FILE_SIZE_BYTES=$(stat -c%s "video_input/$TEMP_FILENAME" 2>/dev/null || stat -f%z "video_input/$TEMP_FILENAME" 2>/dev/null)
            echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶å¤§å°: ${FILE_SIZE} (${FILE_SIZE_BYTES} å­—èŠ‚)"

            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆå¦‚æœæœ‰é¢„æœŸå¤§å°ï¼‰
            if [ -n "$CONTENT_LENGTH" ] && [ "$CONTENT_LENGTH" -gt 0 ]; then
              if [ "$FILE_SIZE_BYTES" -eq "$CONTENT_LENGTH" ]; then
                echo "âœ… æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡"
              else
                echo "âš ï¸ æ–‡ä»¶å¤§å°ä¸åŒ¹é… (é¢„æœŸ: $CONTENT_LENGTH, å®é™…: $FILE_SIZE_BYTES)"
              fi
            fi

            # é‡å‘½åä¸´æ—¶æ–‡ä»¶åˆ°æœ€ç»ˆæ–‡ä»¶å
            echo "ğŸ”„ é‡å‘½åæ–‡ä»¶: $TEMP_FILENAME â†’ $FINAL_FILENAME"
            mv "video_input/$TEMP_FILENAME" "video_input/$FINAL_FILENAME"

            if [ -f "video_input/$FINAL_FILENAME" ]; then
              echo "âœ… æ–‡ä»¶é‡å‘½åæˆåŠŸ: $FINAL_FILENAME"
            else
              echo "âŒ æ–‡ä»¶é‡å‘½åå¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆæˆ–ä¸ºç©º"
            exit 1
          fi
        else
          echo "âŒ è§†é¢‘ä¸‹è½½å¤±è´¥"
          exit 1
        fi
      env:
        VIDEO_URL: ${{ inputs.video_url }}
    
    - name: ç”Ÿæˆæˆªå›¾
      env:
        TZ: Asia/Shanghai
      run: |
        echo "ğŸ¬ å¼€å§‹ç”Ÿæˆæˆªå›¾..."

        # è®¾ç½®æ—¶åŒº
        export TZ=Asia/Shanghai

        # ä»æœ€ç»ˆæ–‡ä»¶åä¸­æå–åŸºç¡€åç§°ï¼ˆä¸å«æ‰©å±•åï¼‰
        VIDEO_FILENAME=$(echo "$FINAL_FILENAME" | sed 's/\.[^.]*$//')
        # æ³¨æ„ï¼šä¿æŒä¸­æ–‡å­—ç¬¦ï¼Œåªæ¸…ç†åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰é—®é¢˜çš„å­—ç¬¦
        VIDEO_FILENAME=$(echo "$VIDEO_FILENAME" | sed 's/[<>:"|?*\/\\]/_/g' | sed 's/__*/_/g' | sed 's/^_\|_$//g')

        # ä¸ºDockerå®¹å™¨åˆ›å»ºASCIIå®‰å…¨çš„å·¥ä½œæ–‡ä»¶åï¼ˆç”¨äºå†…éƒ¨å¤„ç†ï¼‰
        # ä½†ä¿æŒåŸå§‹æ–‡ä»¶åç”¨äºæœ€ç»ˆè¾“å‡º
        DOCKER_SAFE_FILENAME=$(echo "$FINAL_FILENAME" | sed 's/[^a-zA-Z0-9._-]/_/g' | sed 's/__*/_/g' | sed 's/^_\|_$//g')
        if [ "$DOCKER_SAFE_FILENAME" != "$FINAL_FILENAME" ]; then
          echo "ğŸ“ Dockerå®‰å…¨æ–‡ä»¶å: $DOCKER_SAFE_FILENAME"
          # åˆ›å»ºASCIIå®‰å…¨çš„ç¬¦å·é“¾æ¥
          ln -sf "$FINAL_FILENAME" "video_input/$DOCKER_SAFE_FILENAME"
        else
          DOCKER_SAFE_FILENAME="$FINAL_FILENAME"
        fi

        echo "ğŸ“ å¤„ç†æ–‡ä»¶: $FINAL_FILENAME"
        echo "ğŸ“ åŸºç¡€æ–‡ä»¶å: $VIDEO_FILENAME"
        echo "VIDEO_FILENAME=$VIDEO_FILENAME" >> $GITHUB_ENV

        # è¿è¡Œ shot-stitch Docker å®¹å™¨ï¼Œä½¿ç”¨ASCIIå®‰å…¨çš„æ–‡ä»¶å
        # è®¾ç½®UTF-8ç¯å¢ƒå˜é‡ä»¥æ”¯æŒä¸­æ–‡æ–‡ä»¶åï¼Œå¹¶è®¾ç½®æ—¶åŒº
        docker run --rm \
          -e LANG=C.UTF-8 \
          -e LC_ALL=C.UTF-8 \
          -e TZ=Asia/Shanghai \
          -v $(pwd)/video_input:/data \
          dreamytzk/shot-stitch:latest \
          "/data/$DOCKER_SAFE_FILENAME" \
          --preset ${{ inputs.preset }} \
          --html \
          --force \
          --keep-frames

        # å¦‚æœä½¿ç”¨äº†ASCIIå®‰å…¨æ–‡ä»¶åï¼Œéœ€è¦é‡å‘½åç”Ÿæˆçš„æ–‡ä»¶
        if [ "$DOCKER_SAFE_FILENAME" != "$FINAL_FILENAME" ]; then
          echo "ğŸ”„ é‡å‘½åç”Ÿæˆçš„æ–‡ä»¶å›ä¸­æ–‡æ–‡ä»¶å..."
          DOCKER_SAFE_BASE=$(echo "$DOCKER_SAFE_FILENAME" | sed 's/\.[^.]*$//')

          # é‡å‘½åæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          for file in video_input/${DOCKER_SAFE_BASE}*; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "$DOCKER_SAFE_FILENAME" ]; then
              new_name=$(echo "$(basename "$file")" | sed "s/^${DOCKER_SAFE_BASE}/${VIDEO_FILENAME}/")
              mv "$file" "video_input/$new_name"
              echo "  é‡å‘½å: $(basename "$file") â†’ $new_name"
            fi
          done

          # åˆ é™¤ASCIIå®‰å…¨çš„ç¬¦å·é“¾æ¥
          rm -f "video_input/$DOCKER_SAFE_FILENAME"
        fi

        # å®šä¹‰æŸ¥æ‰¾ç”Ÿæˆæ–‡ä»¶çš„å‡½æ•°ï¼ˆé¿å…evalï¼‰
        find_generated_files() {
          find video_input/ -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" -o -name "*.html" \) ! -name "$FINAL_FILENAME"
        }

        # å®šä¹‰æŸ¥æ‰¾å°å›¾ç‰‡æ–‡ä»¶çš„å‡½æ•°
        find_frame_files() {
          find video_input/ -type f -path "*_frames/*" \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \)
        }

        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        SCREENSHOT_COUNT=$(find_generated_files | wc -l)
        FRAME_COUNT=$(find_frame_files | wc -l)

        if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•æˆªå›¾æ–‡ä»¶"
          exit 1
        fi

        echo "âœ… æˆªå›¾ç”Ÿæˆå®Œæˆï¼Œå…±ç”Ÿæˆ $SCREENSHOT_COUNT ä¸ªä¸»æ–‡ä»¶"
        if [ "$FRAME_COUNT" -gt 0 ]; then
          echo "âœ… ä¿ç•™äº† $FRAME_COUNT å¼ å°å›¾ç‰‡"
        fi

        # åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        echo "ğŸ“Š ç”Ÿæˆçš„ä¸»æ–‡ä»¶:"
        find_generated_files | while read file; do
          echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
        done

        if [ "$FRAME_COUNT" -gt 0 ]; then
          echo "ğŸ“Š ä¿ç•™çš„å°å›¾ç‰‡:"
          find_frame_files | head -5 | while read file; do
            echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
          done
          if [ "$FRAME_COUNT" -gt 5 ]; then
            echo "  - ... è¿˜æœ‰ $((FRAME_COUNT - 5)) å¼ å°å›¾ç‰‡"
          fi
        fi
    
    - name: å‡†å¤‡ Release ä¿¡æ¯
      env:
        TZ: Asia/Shanghai
      run: |
        TIMESTAMP=$(TZ="Asia/Shanghai" date +"%Y%m%d_%H%M%S")
        RELEASE_TAG="screenshots-${TIMESTAMP}"
        RELEASE_NAME="$VIDEO_FILENAME æˆªå›¾ - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        TARGET_REPO="${{ inputs.target_repo }}"

        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
        echo "TARGET_REPO=$TARGET_REPO" >> $GITHUB_ENV

        # åˆ›å»º Release æè¿°
        echo "# è§†é¢‘æˆªå›¾æ–‡ä»¶" > release_notes.md
        echo "" >> release_notes.md
        echo "**è§†é¢‘æ–‡ä»¶å**: \`$VIDEO_FILENAME\`" >> release_notes.md
        # å¦‚æœä½¿ç”¨äº†è‡ªå®šä¹‰æ–‡ä»¶åæˆ–è¿›è¡Œäº†URLè§£ç ï¼Œæ˜¾ç¤ºåŸå§‹URLæ–‡ä»¶å
        if [ -n "${{ inputs.custom_filename }}" ] || [[ "$URL_FILENAME" =~ %[0-9A-Fa-f]{2} ]]; then
          echo "**åŸå§‹URLæ–‡ä»¶å**: \`$URL_FILENAME\`" >> release_notes.md
        fi
        echo "**é¢„è®¾æ¨¡å¼**: \`${{ inputs.preset }}\`" >> release_notes.md
        echo "**ç›®æ ‡ä»“åº“**: \`$TARGET_REPO\`" >> release_notes.md
        echo "**ç”Ÿæˆæ—¶é—´**: \`$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## åŒ…å«æ–‡ä»¶" >> release_notes.md

        # æ”¶é›†é¢„è§ˆå›¾æ–‡ä»¶ï¼ˆä¸ä¸Šä¼ é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
        preview_files=()
        while IFS= read -r -d '' file; do
          filename=$(basename "$file")
          if [ "$filename" != "$FINAL_FILENAME" ]; then
            preview_files+=("$file")
          fi
        done < <(find video_input/ -maxdepth 1 -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \) -print0 2>/dev/null)

        # æ·»åŠ é¢„è§ˆå›¾æ–‡ä»¶åˆ°release notes
        if [ ${#preview_files[@]} -gt 0 ]; then
          echo "### é¢„è§ˆå›¾æ–‡ä»¶" >> release_notes.md
          for file in "${preview_files[@]}"; do
            echo "- \`$(basename "$file")\` ($(du -h "$file" | cut -f1))" >> release_notes.md
          done
          echo "" >> release_notes.md
        fi

        # æ·»åŠ å‹ç¼©åŒ…ä¿¡æ¯
        echo "### å‹ç¼©åŒ…æ–‡ä»¶" >> release_notes.md

        # é¢„è§ˆå›¾å‹ç¼©åŒ…
        html_count=$(find video_input/ -maxdepth 1 -type f -name "*.html" | wc -l)
        if [ ${#preview_files[@]} -gt 0 ] || [ $html_count -gt 0 ]; then
          echo "- \`${VIDEO_FILENAME}_previews.zip\` (åŒ…å«æ‰€æœ‰é¢„è§ˆå›¾å’ŒHTMLæŠ¥å‘Š)" >> release_notes.md
        fi

        # å°å›¾å‹ç¼©åŒ…ï¼ˆåŠ¨æ€æŸ¥æ‰¾framesç›®å½•ï¼‰
        frames_dir=""
        for dir in video_input/*_frames/; do
          if [ -d "$dir" ]; then
            frames_dir="$dir"
            break
          fi
        done

        if [ -n "$frames_dir" ] && [ -d "$frames_dir" ]; then
          frame_count=$(find "$frames_dir" -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \) | wc -l)
          if [ $frame_count -gt 0 ]; then
            echo "- \`${VIDEO_FILENAME}_frames.zip\` (åŒ…å« $frame_count å¼ å°å›¾)" >> release_notes.md
          fi
        fi

        echo "" >> release_notes.md
        echo "- \`${VIDEO_FILENAME}_all_files.zip\` (åŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…)" >> release_notes.md
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> release_notes.md

        echo "âœ… Release ä¿¡æ¯å‡†å¤‡å®Œæˆ"
    
    - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      env:
        TZ: Asia/Shanghai
        GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
      run: |
        echo "ğŸš€ åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶..."

        # åˆ›å»º Release
        gh release create "$RELEASE_TAG" \
          --repo "$TARGET_REPO" \
          --title "$RELEASE_NAME" \
          --notes-file release_notes.md

        echo "âœ… Release åˆ›å»ºæˆåŠŸ: $RELEASE_TAG"

        # ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯
        echo "ï¿½ åˆ†æç”Ÿæˆçš„æ–‡ä»¶..."

        # æŸ¥æ‰¾é¢„è§ˆå›¾æ–‡ä»¶ï¼ˆvideo_inputæ ¹ç›®å½•ä¸‹çš„å›¾ç‰‡ï¼Œæ’é™¤åŸå§‹è§†é¢‘ï¼‰
        preview_files=()
        while IFS= read -r -d '' file; do
          filename=$(basename "$file")
          if [ "$filename" != "$FINAL_FILENAME" ]; then
            preview_files+=("$file")
          fi
        done < <(find video_input/ -maxdepth 1 -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \) -print0 2>/dev/null)

        # æŸ¥æ‰¾HTMLæ–‡ä»¶
        html_files=()
        while IFS= read -r -d '' file; do
          html_files+=("$file")
        done < <(find video_input/ -maxdepth 1 -type f -name "*.html" -print0 2>/dev/null)

        # åŠ¨æ€æŸ¥æ‰¾å°å›¾æ–‡ä»¶å¤¹ï¼ˆå¯èƒ½æœ‰ä¸åŒçš„å‘½åï¼‰
        frames_dir=""
        for dir in video_input/*_frames/; do
          if [ -d "$dir" ]; then
            frames_dir="$dir"
            break
          fi
        done

        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ï¼š"
        echo "  - é¢„è§ˆå›¾æ–‡ä»¶: ${#preview_files[@]} ä¸ª"
        echo "  - HTMLæ–‡ä»¶: ${#html_files[@]} ä¸ª"
        if [ -n "$frames_dir" ] && [ -d "$frames_dir" ]; then
          frame_count=$(find "$frames_dir" -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \) | wc -l)
          echo "  - å°å›¾æ–‡ä»¶: $frame_count ä¸ª (ç›®å½•: $(basename "$frames_dir"))"
        else
          echo "  - å°å›¾æ–‡ä»¶: 0 ä¸ªï¼ˆæœªæ‰¾åˆ°framesç›®å½•ï¼‰"
        fi

        # ç¬¬äºŒæ­¥ï¼šä¸Šä¼ é¢„è§ˆå›¾æ–‡ä»¶
        if [ ${#preview_files[@]} -gt 0 ]; then
          echo "ğŸ“¤ ä¸Šä¼ é¢„è§ˆå›¾æ–‡ä»¶..."
          for i in "${!preview_files[@]}"; do
            file="${preview_files[$i]}"
            filename=$(basename "$file")
            echo "ğŸ“¤ ä¸Šä¼ ç¬¬$((i+1))å¼ é¢„è§ˆå›¾: $filename"

            gh release upload "$RELEASE_TAG" "$file" \
              --repo "$TARGET_REPO" \
              --clobber
          done
        fi

        # ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºå¹¶ä¸Šä¼ é¢„è§ˆå›¾å‹ç¼©åŒ…
        if [ ${#preview_files[@]} -gt 0 ] || [ ${#html_files[@]} -gt 0 ]; then
          echo "ğŸ“¦ åˆ›å»ºé¢„è§ˆå›¾å‹ç¼©åŒ…..."
          mkdir -p temp_previews

          # å¤åˆ¶é¢„è§ˆå›¾æ–‡ä»¶
          for file in "${preview_files[@]}"; do
            cp "$file" temp_previews/
          done

          # å¤åˆ¶HTMLæ–‡ä»¶
          for file in "${html_files[@]}"; do
            cp "$file" temp_previews/
          done

          cd temp_previews
          previews_zip_filename="${VIDEO_FILENAME}_previews.zip"
          zip -r "$previews_zip_filename" . >/dev/null
          echo "ğŸ“¤ ä¸Šä¼ é¢„è§ˆå›¾å‹ç¼©åŒ…: $previews_zip_filename"

          gh release upload "$RELEASE_TAG" "$previews_zip_filename" \
            --repo "$TARGET_REPO" \
            --clobber
          cd ..
        fi

        # ç¬¬å››æ­¥ï¼šåˆ›å»ºå¹¶ä¸Šä¼ å°å›¾å‹ç¼©åŒ…
        if [ -n "$frames_dir" ] && [ -d "$frames_dir" ]; then
          frame_files=($(find "$frames_dir" -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \)))
          if [ ${#frame_files[@]} -gt 0 ]; then
            echo "ğŸ“¦ åˆ›å»ºå°å›¾å‹ç¼©åŒ…..."
            mkdir -p temp_frames

            # å¤åˆ¶æ‰€æœ‰å°å›¾æ–‡ä»¶
            for file in "${frame_files[@]}"; do
              cp "$file" temp_frames/
            done

            cd temp_frames
            frames_zip_filename="${VIDEO_FILENAME}_frames.zip"
            zip -r "$frames_zip_filename" . >/dev/null
            echo "ğŸ“¤ ä¸Šä¼ å°å›¾å‹ç¼©åŒ…: $frames_zip_filename (åŒ…å« ${#frame_files[@]} ä¸ªæ–‡ä»¶)"

            gh release upload "$RELEASE_TAG" "$frames_zip_filename" \
              --repo "$TARGET_REPO" \
              --clobber
            cd ..
          else
            echo "â„¹ï¸ å°å›¾æ–‡ä»¶å¤¹ä¸ºç©ºï¼Œè·³è¿‡å°å›¾å‹ç¼©åŒ…åˆ›å»º"
          fi
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°å°å›¾æ–‡ä»¶å¤¹ï¼Œè·³è¿‡å°å›¾å‹ç¼©åŒ…åˆ›å»º"
        fi

        echo "âœ… æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
        echo "RELEASE_URL=https://github.com/$TARGET_REPO/releases/tag/$RELEASE_TAG" >> $GITHUB_ENV

    
    - name: ç”Ÿæˆä¸‹è½½ä¿¡æ¯
      env:
        TZ: Asia/Shanghai
      run: |
        echo "ğŸ‰ æˆªå›¾å·²æˆåŠŸä¸Šä¼ åˆ°ç›®æ ‡ä»“åº“!"
        echo ""
        echo "ğŸ“ ç›®æ ‡ä»“åº“: $TARGET_REPO"
        echo "ğŸ·ï¸  Release æ ‡ç­¾: $RELEASE_TAG"
        echo "ğŸ”— Release é“¾æ¥: $RELEASE_URL"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
        echo "1. è®¿é—®ç›®æ ‡ä»“åº“çš„ Releases é¡µé¢"
        echo "2. æ‰¾åˆ°æ ‡ç­¾ä¸º '$RELEASE_TAG' çš„ Release"
        echo "3. ç›´æ¥ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼ˆæ— éœ€è§£å‹ï¼‰"
        echo ""

        echo "ğŸ“Š åŒ…å«æ–‡ä»¶:"

        # é‡æ–°æ”¶é›†æ–‡ä»¶ä¿¡æ¯ï¼ˆä¸ä¸Šä¼ é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
        # æŸ¥æ‰¾é¢„è§ˆå›¾æ–‡ä»¶
        uploaded_preview_files=()
        while IFS= read -r -d '' file; do
          filename=$(basename "$file")
          if [ "$filename" != "$FINAL_FILENAME" ]; then
            uploaded_preview_files+=("$file")
          fi
        done < <(find video_input/ -maxdepth 1 -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \) -print0 2>/dev/null)

        # æ˜¾ç¤ºä¸Šä¼ çš„é¢„è§ˆå›¾æ–‡ä»¶
        for file in "${uploaded_preview_files[@]}"; do
          filename=$(basename "$file")
          size=$(du -h "$file" | cut -f1)
          echo "  - $filename ($size)"
        done

        # æ˜¾ç¤ºé¢„è§ˆå›¾å‹ç¼©åŒ…ï¼ˆå¦‚æœæœ‰é¢„è§ˆå›¾æˆ–HTMLæ–‡ä»¶ï¼‰
        html_count=$(find video_input/ -maxdepth 1 -type f -name "*.html" | wc -l)
        if [ ${#uploaded_preview_files[@]} -gt 0 ] || [ $html_count -gt 0 ]; then
          echo "  - ${VIDEO_FILENAME}_previews.zip"
        fi

        # æ˜¾ç¤ºå°å›¾å‹ç¼©åŒ…ï¼ˆåŠ¨æ€æŸ¥æ‰¾framesç›®å½•ï¼‰
        frames_dir=""
        for dir in video_input/*_frames/; do
          if [ -d "$dir" ]; then
            frames_dir="$dir"
            break
          fi
        done

        if [ -n "$frames_dir" ] && [ -d "$frames_dir" ]; then
          frame_count=$(find "$frames_dir" -type f \( -name "*.webp" -o -name "*.jpg" -o -name "*.png" \) | wc -l)
          if [ $frame_count -gt 0 ]; then
            echo "  - ${VIDEO_FILENAME}_frames.zip"
          fi
        fi

        echo ""
        echo "ğŸ”’ åªæœ‰ç›®æ ‡ä»“åº“çš„åä½œè€…å¯ä»¥è®¿é—®å’Œä¸‹è½½"
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        # ä½¿ç”¨ sudo æ¥å¤„ç†æƒé™é—®é¢˜ï¼ŒDocker åˆ›å»ºçš„æ–‡ä»¶å¯èƒ½æœ‰ä¸åŒçš„æƒé™
        sudo rm -rf video_input/ release_notes.md temp_previews/ temp_frames/ || {
          echo "âš ï¸ éƒ¨åˆ†æ–‡ä»¶æ¸…ç†å¤±è´¥ï¼Œå°è¯•ä¿®æ”¹æƒé™åé‡è¯•..."
          sudo chmod -R 777 video_input/ 2>/dev/null || true
          sudo rm -rf video_input/ release_notes.md temp_previews/ temp_frames/ || true
        }
        echo "âœ… æ¸…ç†å®Œæˆ"
